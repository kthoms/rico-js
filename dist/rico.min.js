/*!
 * Copyright 2018 Karakun AG.
 * Copyright 2015-2018 Canoo Engineering AG.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ricojs=t():e.ricojs=t()}(window,function(){return function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=1)}([function(e,t){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}(e.exports=n).prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},n.prototype.once=function(e,t){var n=this;function r(){n.off(e,r),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=t,this.on(e,r),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var o=0;o<r.length;o++)if((n=r[o])===t||n.fn===t){r.splice(o,1);break}return this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var r=0,o=(n=n.slice(0)).length;r<o;++r)n[r].apply(this,t);return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length}},function(e,t,n){"use strict";n.r(t);var r,d={NONE:{name:"NONE",text:"[NONE ]",level:0},ALL:{name:"ALL",text:"[ALL  ]",level:100},TRACE:{name:"TRACE",text:"[TRACE]",level:5},DEBUG:{name:"DEBUG",text:"[DEBUG]",level:4},INFO:{name:"INFO",text:"[INFO ]",level:3},WARN:{name:"WARN",text:"[WARN ]",level:2},ERROR:{name:"ERROR",text:"[ERROR]",level:1}};function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,a=void 0;try{for(var i,l=e[Symbol.iterator]();!(r=(i=l.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function p(e){return null!=e}function v(e){r=e}function y(e,t){if(!p(e))throw new Error("The parameter "+t+" is mandatory in "+r)}function a(e){var t,n=e.match(/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/);n[4]&&1<n[4].length&&(t=n[4].substring(0,n[4].length-1));var r,o,a=n[13];n[16]&&1<n[16].length&&(r=(r=n[16].substring(1,n[16].length)).split("&").reduce(function(e,t){var n,r,o,a=u(t.split("="),2),i=a[0],l=a[1];return Object.assign(e,(o=l,(r=i)in(n={})?Object.defineProperty(n,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[r]=o,n))},{}));n[17]&&1<n[17].length&&(o=n[17].substring(1,n[17].length));var i=n[11],l=n[12];return i&&!l&&"http"===t?l=80:i&&!l&&"https"===t&&(l=443),i||l||t||(window&&window.location&&window.location.hostname&&(i=window.location.hostname),window&&window.location&&window.location.port&&(l=window.location.port),window&&window.location&&window.location.protocol&&(t=window.location.protocol.substring(0,window.location.protocol.length-1)),0===a.indexOf(".")&&(a=a.substring(1,a.length))),l&&(l=parseInt(l)),{scheme:t,user:n[8],password:n[9],hostname:i,port:l,path:a,query:r,fragment:o}}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var l={pad:function(e,t){for(var n=""+e;n.length<t;)n="0"+n;return n},internalLog:function(){var e=Array.from(arguments),t=e.shift(),n=e.shift(),r=e.shift(),o=new Date,a=o.getFullYear()+"-"+l.pad(o.getMonth()+1,2)+"-"+l.pad(o.getDate(),2)+" "+l.pad(o.getHours(),2)+":"+l.pad(o.getMinutes(),2)+":"+l.pad(o.getSeconds(),2)+"."+l.pad(o.getMilliseconds(),3);t.apply(void 0,[a,r.text,n].concat(i(e)))},getCookie:function(e){if(p(window)&&p(window.document)&&p(window.document.cookie)){var t=("; "+window.document.cookie).split("; "+e+"=");if(2===t.length)return t.pop().split(";").shift()}}},s=function(){function n(e,t){switch(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.context=e,this.rootLogger=t,l.getCookie("RICO_LOGGER_"+this.context)){case"NONE":this.logLevel=d.NONE;break;case"ALL":this.logLevel=d.ALL;break;case"TRACE":this.logLevel=d.TRACE;break;case"DEBUG":this.logLevel=d.DEBUG;break;case"INFO":this.logLevel=d.INFO;break;case"WARN":this.logLevel=d.WARN;break;case"ERROR":this.logLevel=d.ERROR}}var e,t,r;return e=n,(t=[{key:"trace",value:function(){p(console)&&this.isLogLevel(d.TRACE)&&l.internalLog.apply(l,[console.log,this.context,d.TRACE].concat(Array.prototype.slice.call(arguments)))}},{key:"debug",value:function(){p(console)&&this.isLogLevel(d.DEBUG)&&l.internalLog.apply(l,[console.log,this.context,d.DEBUG].concat(Array.prototype.slice.call(arguments)))}},{key:"info",value:function(){p(console)&&this.isLogLevel(d.INFO)&&l.internalLog.apply(l,[console.log,this.context,d.INFO].concat(Array.prototype.slice.call(arguments)))}},{key:"warn",value:function(){p(console)&&this.isLogLevel(d.WARN)&&l.internalLog.apply(l,[console.warn,this.context,d.WARN].concat(Array.prototype.slice.call(arguments)))}},{key:"error",value:function(){p(console)&&this.isLogLevel(d.ERROR)&&l.internalLog.apply(l,[console.error,this.context,d.ERROR].concat(Array.prototype.slice.call(arguments)))}},{key:"getLogLevel",value:function(){return p(this.logLevel)?this.logLevel:p(this.rootLogger)?this.rootLogger.getLogLevel():d.INFO}},{key:"setLogLevel",value:function(e){this.logLevel=e}},{key:"setLogLevelByName",value:function(e){p(d[e])&&(this.logLevel=d[e])}},{key:"isLogLevel",value:function(e){return this.getLogLevel()!==d.NONE&&(this.getLogLevel()===d.ALL||(this.getLogLevel()===d.TRACE||(this.getLogLevel()===d.DEBUG&&e!==d.TRACE||(this.getLogLevel()===d.INFO&&e!==d.TRACE&&e!==d.DEBUG||(this.getLogLevel()===d.WARN&&e!==d.TRACE&&e!==d.DEBUG&&e!==d.INFO||this.getLogLevel()===d.ERROR&&e!==d.TRACE&&e!==d.DEBUG&&e!==d.INFO&&e!==d.WARN)))))}},{key:"isLogLevelUseable",value:function(e){return y(e,"level"),!!e.level&&this.getLogLevel().level>=e.level}}])&&o(e.prototype,t),r&&o(e,r),n}();function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var f=new s("ROOT"),h={loggers:new Map},m=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"getLogger",value:function(e){if(!p(e)||"ROOT"===e)return f;var t=h.loggers.get(e);if(t)return t;var n=new s(e,f);return h.loggers.set(e,n),n}}],(n=null)&&c(t.prototype,n),r&&c(t,r),e}();var g=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};function C(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}g.LOGGER=m.getLogger("Client"),g.services=new Map,g.serviceProviders=new Map,g.configuration={},g.getService=function(e){var t=g.services.get(e);if(!p(t)){var n=g.serviceProviders.get(e);if(!p(n))throw new Error("No service provider found for "+e);t=n.getService(g.configuration),g.services.set(e,t)}return t},g.hasService=function(e){return!!p(g.serviceProviders.get(e))},g.getAllServiceTypes=function(){var t=[];return g.serviceProviders.forEach(function(e){return t.push(e)}),t},g.registerServiceProvider=function(e){if(null==e)throw new Error("Cannot register empty service provider");if("function"!=typeof e.getName||"function"!=typeof e.getService)throw new Error("Cannot register service provider without getName() and getService() methods");if(g.serviceProviders.get(e.getName()))throw new Error("Cannot register another service provider. Name already in use.");g.serviceProviders.set(e.getName(),e),g.LOGGER.debug("Service provider registered with name",e.getName())},g.init=function(){g.serviceProviders.forEach(function(e){var t=e.getService();g.LOGGER.trace("Initializing service for service provider",e.getName()),"function"==typeof t.initServiceProvider&&(g.LOGGER.debug("Initializing service",t),t.initServiceProvider(g))})};var b=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),v("constructor"),y(e,"serviceClass"),y(t,"name"),this.serviceInstance=new e(n),this.name=t}var e,t,n;return e=r,(t=[{key:"getName",value:function(){return this.name}},{key:"getService",value:function(){return this.serviceInstance}}])&&C(e.prototype,t),n&&C(e,n),r}(),E="arraybuffer",w="text",R="json",T={METHOD:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},STATUS:{ACCEPTED:202,BAD_GATEWAY:502,BAD_REQUEST:400,CONFLICT:409,CONTINUE:100,CREATED:201,EXPECTATION_FAILED:417,FAILED_DEPENDENCY:424,FORBIDDEN:403,GATEWAY_TIMEOUT:504,GONE:410,HTTP_VERSION_NOT_SUPPORTED:505,IM_A_TEAPOT:418,INSUFFICIENT_SPACE_ON_RESOURCE:419,INSUFFICIENT_STORAGE:507,INTERNAL_SERVER_ERROR:500,LENGTH_REQUIRED:411,LOCKED:423,METHOD_FAILURE:420,METHOD_NOT_ALLOWED:405,MOVED_PERMANENTLY:301,MOVED_TEMPORARILY:302,MULTI_STATUS:207,MULTIPLE_CHOICES:300,NETWORK_AUTHENTICATION_REQUIRED:511,NO_CONTENT:204,NON_AUTHORITATIVE_INFORMATION:203,NOT_ACCEPTABLE:406,NOT_FOUND:404,NOT_IMPLEMENTED:501,NOT_MODIFIED:304,OK:200,PARTIAL_CONTENT:206,PAYMENT_REQUIRED:402,PERMANENT_REDIRECT:308,PRECONDITION_FAILED:412,PRECONDITION_REQUIRED:428,PROCESSING:102,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_HEADER_FIELDS_TOO_LARGE:431,REQUEST_TIMEOUT:408,REQUEST_TOO_LONG:413,REQUEST_URI_TOO_LONG:414,REQUESTED_RANGE_NOT_SATISFIABLE:416,RESET_CONTENT:205,SEE_OTHER:303,SERVICE_UNAVAILABLE:503,SWITCHING_PROTOCOLS:101,TEMPORARY_REDIRECT:307,TOO_MANY_REQUESTS:429,UNAUTHORIZED:401,UNPROCESSABLE_ENTITY:422,UNSUPPORTED_MEDIA_TYPE:415,USE_PROXY:305},HEADER_NAME:{ACCEPT:"Accept",ACCEPT_CHARSET:"Accept-Charset",ACCEPT_ENCODING:"Accept-Encoding",ACCEPT_LANGUAGE:"Accept-Language",ACCEPT_DATETIME:"Accept-Datetime",AUTHORIZATION:"Authorization",CACHE_CONTROL:"Cache-Control",CONNECTION:"Connection",COOKIE:"Cookie",CONTENT_LENGTH:"Content-Length",CONTENT_MD5:"Content-MD5",CONTENT_TYPE:"Content-Type",DATE:"Date",EXPECT:"Expect",FORWARDED:"Forwarded",FROM:"From",HOST:"Host",IF_MATCH:"If-Match",IF_MODIFIED_SINCE:"If-Modified_Since",IF_NONE_MATCH:"If-None_Match",IF_RANGE:"If-Range",MAX_FORWARDS:"Max-Forwards",PRAGMA:"Pragma",PROXY_AUTHORIZATION:"Proxy-Authorization",REFERER:"Referer",TE:"TE",USER_AGENT:"User-Agent",X_CLIENT_ID:"X-Client-Id",X_CLIENT_SESSION_ID:"X-Client-Session-Id",X_PLATFORM_SECURITY_REALM:"X-platform-security-realm",X_PLATFORM_SECURITY_BEARER_ONLY:"X-platform-security-bearer-only",X_PLATFORM_SECURITY_APPLICATION:"X-platform-security-application"},CONTENT_TYPE:{APPLICATION_JSON:"application/json",APPLICATION_X_WWW_FORM_URLENCODED:"application/x-www-form-urlencoded",TEXT_HTML:"text/html",TEXT_PLAIN:"text/plain"},XMLHTTPREQUEST_READYSTATE:{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4}},k="/openid-connect";function A(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var P=function(){function s(e,t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),this.url=e,this.status=t,this.content=n,this.headers={},p(r)&&"string"==typeof r)for(var o=r.trim().split(/[\r\n]+/),a=0;a<o.length;a++){var i=o[a].split(": ");if(2===i.length){var l=i.shift().toLowerCase(),u=i.join(": ");this.headers[l]=u}}}var e,t,n;return e=s,(t=[{key:"getUrl",value:function(){return this.url}},{key:"getContent",value:function(){return this.content}},{key:"getStatus",value:function(){return this.status}},{key:"getHeaders",value:function(){return this.headers}},{key:"getHeaderByName",value:function(e){return v("getHeaderByName"),y(e,"name"),this.headers[e.toLowerCase()]}}])&&A(e.prototype,t),n&&A(e,n),s}();function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.message=e,this.status=t||0,this.timedout=n||!1}var e,t,n;return e=r,(t=[{key:"getMessage",value:function(){return this.message}},{key:"getStatus",value:function(){return this.status}},{key:"isTimedout",value:function(){return this.timedout}}])&&O(e.prototype,t),n&&O(e,n),r}();function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var I=function(){function f(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),this.configuration=e,this.client=t}var e,t,n;return e=f,(t=[{key:"execute",value:function(e,t){var u=this,n=null;this.client&&this.client.hasService("HttpWorker")&&(n=this.client.getService("HttpWorker"));var r=null!==n&&(!0===t||!0===e),s=0;!0!==e&&!1!==e&&(s=e);var c=[];this.client&&(c=this.client.getService("HttpClientInterceptor").getRequestInterceptors(),f.LOGGER.trace("Request interceptors found:",c));var d=[];this.client&&(d=this.client.getService("HttpClientInterceptor").getResponseInterceptors(),f.LOGGER.trace("Response interceptors found:",d));var o=function(r,o){var a=u,e=new XMLHttpRequest;e.open(u.configuration.method,u.configuration.url,!0),e.url=u.configuration.url,e.method=u.configuration.method,e.withCredentials=!0;for(var t=0;t<c.length;t++){c[t].handleRequest(e)}if(u.configuration.headers&&0<u.configuration.headers.length)for(var n=0;n<u.configuration.headers.length;n++){var i=u.configuration.headers[n];e.setRequestHeader(i.name,i.value)}e.timeout=s,u.configuration.responseType&&(e.responseType=u.configuration.responseType),e.ontimeout=function(){var e=this.statusText||"Timeout occurred",t=new _(e,this.status,!0);f.LOGGER.error(t),o(t)},e.onerror=function(){var e=this.statusText||"Unspecified error occured",t=new _(e,this.status);f.LOGGER.error(t),o(t)},e.onreadystatechange=function(){if(this.readyState===T.XMLHTTPREQUEST_READYSTATE.DONE&&f.LOGGER.trace("Request to ",a.configuration.url,"finished with",this.status),this.readyState===T.XMLHTTPREQUEST_READYSTATE.DONE&&200<=this.status&&this.status<300){for(var e=new P(this.url,this.status,this.response,this.getAllResponseHeaders()),t=0;t<d.length;t++){d[t].handleResponse(e)}r(e)}else if(this.readyState===T.XMLHTTPREQUEST_READYSTATE.DONE&&300<=this.status){var n=new _(this.statusText,this.status);f.LOGGER.error(n),o(n)}},e.send(u.configuration.requestBody)};o=o.bind(this);var a=function(a,i){for(var r=[],e=0;e<c.length;e++){c[e].handleRequest({url:u.configuration.url,setRequestHeader:function(e,t){var n={name:e,value:t};r.push(n)}})}var l=n.createWorker();try{l.onmessage=function(e){l.terminate(),f.LOGGER.trace("Message form Worker",e);var t=e.data;if(t.error){var n=new _(t.message,t.status,t.timedout);f.LOGGER.error(n),i(n)}else{for(var r=new P(t.url,t.status,t.response,t.responseHeaders),o=0;o<d.length;o++){d[o].handleResponse(r)}a(r)}},l.onerror=function(e){var t=new _(e.data,0,!1);i(t)},l.postMessage({conf:u.configuration,timeout:s,requestHeaders:r})}catch(e){var t=new _(e,0,!1);i(t)}};return a=a.bind(this),new Promise(function(e,t){r&&u.client&&u.client.hasService("HttpWorker")?a(e,t):o(e,t)})}}])&&M(e.prototype,t),n&&M(e,n),f}();function N(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}I.LOGGER=m.getLogger("Executor");var S=function(){function n(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.configuration=e,this.executor=new I(e,t)}var e,t,r;return e=n,(t=[{key:"readBytes",value:function(){return this.configuration.responseType=E,this.executor}},{key:"readString",value:function(){return this.configuration.responseType=w,this.executor}},{key:"readObject",value:function(){return this.configuration.responseType=R,this.executor}},{key:"withoutResult",value:function(){return this.executor}}])&&N(e.prototype,t),r&&N(e,r),n}();function L(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var D=function(){function n(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.configuration=e,this.reponseBuilder=new S(e,t)}var e,t,r;return e=n,(t=[{key:"withHeader",value:function(e,t){return this.configuration.headers||(this.configuration.headers=[]),this.configuration.headers.push({name:e,value:t}),this}},{key:"withHeadersInfo",value:function(e){if(p(e))for(var t in this.configuration.headers||(this.configuration.headers=[]),e)if(e.hasOwnProperty(t)){var n=e[t];this.configuration.headers.push({name:t,value:n})}return this}},{key:"withContent",value:function(e){return this.configuration.requestBody=e,this.reponseBuilder}},{key:"withoutContent",value:function(){return this.reponseBuilder}}])&&L(e.prototype,t),r&&L(e,r),n}();function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var B=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.client=e}var e,n,r;return e=t,(n=[{key:"request",value:function(e,t){var n={url:e,method:t};return this.requestBuilder=new D(n,this.client),this.requestBuilder}},{key:"get",value:function(e){return this.request(e,T.METHOD.GET)}},{key:"post",value:function(e){return this.request(e,T.METHOD.POST)}},{key:"put",value:function(e){return this.request(e,T.METHOD.PUT)}},{key:"delete",value:function(e){return this.request(e,T.METHOD.DELETE)}}])&&H(e.prototype,n),r&&H(e,r),t}();function G(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var U=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.requestHandlers=new Set,this.responseHandlers=new Set}var t,n,r;return t=e,(n=[{key:"addRequestInterceptor",value:function(e){this.requestHandlers.add(e)}},{key:"getRequestInterceptors",value:function(){var t=[];return this.requestHandlers.forEach(function(e){return t.push(e)}),t}},{key:"addResponseInterceptor",value:function(e){this.responseHandlers.add(e)}},{key:"getResponseInterceptors",value:function(){var t=[];return this.responseHandlers.forEach(function(e){return t.push(e)}),t}}])&&G(t.prototype,n),r&&G(t,r),e}();function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var j=function(){function o(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.clientIds=new Map}var e,t,n;return e=o,(t=[{key:"handleRequest",value:function(e){v("handleRequest"),y(e,"httpRequest");var t=this.getClientId(e.url);p(t)&&(o.LOGGER.trace("Using ClientId",t),e.setRequestHeader(T.HEADER_NAME.X_CLIENT_SESSION_ID,t))}},{key:"handleResponse",value:function(e){v("handleResponse"),y(e,"httpResponse");var t=this.getClientId(e.url),n=e.getHeaderByName(T.HEADER_NAME.X_CLIENT_SESSION_ID);if(p(t)&&p(n)&&t!==n)throw new Error("Client Id does not match!");!p(t)&&p(n)&&(o.LOGGER.debug("New ClientId found",n),this.setClientId(e.url,n))}},{key:"initServiceProvider",value:function(e){v("initServiceProvider"),y(e,"client"),e.getService("HttpClientInterceptor").addRequestInterceptor(this),e.getService("HttpClientInterceptor").addResponseInterceptor(this)}},{key:"getClientId",value:function(e){var t=a(e),n=o.calcKey(t.hostname,t.port);return this.clientIds.get(n)}},{key:"setClientId",value:function(e,t){var n=a(e),r=o.calcKey(n.hostname,n.port);this.clientIds.set(r,t),o.LOGGER.trace("Setting ClientId",t,"for",e,"with key",r)}}])&&x(e.prototype,t),n&&x(e,n),o}();j.calcKey=function(e,t){return e+t},j.LOGGER=m.getLogger("ClientScope");var V="AttributeMetadataChanged",q="CallAction",F="ChangeAttributeMetadata",Q="CreateContext",X="CreateController",Y="CreatePresentationModel",W="DeletePresentationModel",K="DestroyContext",z="DestroyController",Z="InterruptLongPoll",J="PresentationModelDeleted",$="StartLongPoll",ee="ValueChanged",te="a_id",ne="p_id",re="c_id";function oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ae=function(){function n(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:50;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.folding=e,this.maxBatchSize=t}var e,t,r;return e=n,(t=[{key:"batch",value:function(e){for(var t=[],n=0;e[n]&&n<=this.maxBatchSize;){var r=e[n];if(n++,this.folding?r.command.id==ee&&0<t.length&&t[t.length-1].command.id==ee&&r.command.attributeId==t[t.length-1].command.attributeId?t[t.length-1].command.newValue=r.command.newValue:r.command.id==J||t.push(r):t.push(r),r.handler)break}return e.splice(0,n),t}}])&&oe(e.prototype,t),r&&oe(e,r),n}(),ie="REMOVED";function le(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ue=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=ee}var t,n,r;return t=e,(n=[{key:"init",value:function(e,t){v("ValueChangedCommand.init()"),y(e,"attributeId"),this.attributeId=e,this.newValue=t}}])&&le(t.prototype,n),r&&le(t,r),e}();function se(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ce=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=V}var t,n,r;return t=e,(n=[{key:"init",value:function(e,t,n){v("AttributeMetadataChangedCommand.init()"),y(e,"attributeId"),y(t,"metadataName"),this.attributeId=e,this.metadataName=t,this.value=n}}])&&se(t.prototype,n),r&&se(t,r),e}();function de(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var fe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=q}var t,n,r;return t=e,(n=[{key:"init",value:function(e,t,n){v("CreateControllerCommand.init()"),y(e,"controllerid"),y(t,"actionName"),this.controllerid=e,this.actionName=t,this.params=n}}])&&de(t.prototype,n),r&&de(t,r),e}();function he(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var pe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=F}var t,n,r;return t=e,(n=[{key:"init",value:function(e,t,n){v("ChangeAttributeMetadataCommand.init()"),y(e,"attributeId"),y(t,"metadataName"),this.attributeId=e,this.metadataName=t,this.value=n}}])&&he(t.prototype,n),r&&he(t,r),e}();var ve=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=Q};function ye(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var me=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=X}var t,n,r;return t=e,(n=[{key:"init",value:function(e,t){v("CreateControllerCommand.init()"),y(e,"controllerName"),this.controllerName=e,this.parentControllerId=t}}])&&ye(t.prototype,n),r&&ye(t,r),e}();function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ce=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=Y}var t,n,r;return t=e,(n=[{key:"init",value:function(e){v("CreatePresentationModelCommand.init()"),y(e,"presentationModel"),this.attributes=[],this.clientSideOnly=!1,this.pmId=e.id,this.pmType=e.presentationModelType;var t=this;e.getAttributes().forEach(function(e){t.attributes.push({propertyName:e.propertyName,id:e.id,value:e.getValue()})})}}])&&ge(t.prototype,n),r&&ge(t,r),e}();function be(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ee=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=W}var t,n,r;return t=e,(n=[{key:"init",value:function(e){v("DeletePresentationModelCommand.init()"),y(e,"pmId"),this.pmId=e}}])&&be(t.prototype,n),r&&be(t,r),e}();var we=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=K};function Re(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Te=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=z}var t,n,r;return t=e,(n=[{key:"init",value:function(e){v("DestroyControllerCommand.init()"),y(e,"controllerId"),this.controllerId=e}}])&&Re(t.prototype,n),r&&Re(t,r),e}();var ke=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=Z};function Ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Pe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=J}var t,n,r;return t=e,(n=[{key:"init",value:function(e){v("PresentationModelDeletedCommand.init()"),y(e,"pmId"),this.pmId=e}}])&&Ae(t.prototype,n),r&&Ae(t,r),e}();var Oe=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=$};function _e(e){return(_e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Me(e,t){return!t||"object"!==_e(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function Ie(e){var r="function"==typeof Map?new Map:void 0;return(Ie=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return Ne(e,arguments,Le(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Se(n,e)})(e)}function Ne(e,t,n){return(Ne=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&Se(o,n.prototype),o}).apply(null,arguments)}function Se(e,t){return(Se=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Le(e){return(Le=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var De=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Me(this,Le(t).call(this,e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Se(e,t)}(t,Ie(Error)),t}();function He(e){return(He="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Be(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ge=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"_encodeAttributeMetadataChangedCommand",value:function(e){v("Codec.encodeAttributeMetadataChangedCommand"),y(e,"command"),y(e.attributeId,"command.attributeId"),y(e.metadataName,"command.metadataName");var t={};return t.id=V,t[te]=e.attributeId,t.n=e.metadataName,t.v=e.value,t}},{key:"_decodeAttributeMetadataChangedCommand",value:function(e){v("Codec.decodeAttributeMetadataChangedCommand"),y(e,"jsonCommand"),y(e[te],"jsonCommand[ATTRIBUTE_ID]"),y(e.n,"jsonCommand[NAME]");var t=new ce;return t.attributeId=e[te],t.metadataName=e.n,t.value=e.v,t}},{key:"_encodeCallActionCommand",value:function(e){v("Codec.encodeCallActionCommand"),y(e,"command"),y(e.controllerid,"command.controllerid"),y(e.actionName,"command.actionName"),y(e.params,"command.params");var t={};return t.id=q,t[re]=e.controllerid,t.n=e.actionName,t.p=e.params.map(function(e){var t={};return t.n=e.name,p(e.value)&&(t.v=e.value),t}),t}},{key:"_decodeCallActionCommand",value:function(e){v("Codec.decodeCallActionCommand"),y(e,"jsonCommand"),y(e[re],"jsonCommand[CONTROLLER_ID]"),y(e.n,"jsonCommand[NAME]"),y(e.p,"jsonCommand[PARAMS]");var t=new fe;return t.controllerid=e[re],t.actionName=e.n,t.params=e.p.map(function(e){return{name:e.n,value:p(e.v)?e.v:null}}),t}},{key:"_encodeChangeAttributeMetadataCommand",value:function(e){v("Codec.encodeChangeAttributeMetadataCommand"),y(e,"command"),y(e.attributeId,"command.attributeId"),y(e.metadataName,"command.metadataName");var t={};return t.id=F,t[te]=e.attributeId,t.n=e.metadataName,t.v=e.value,t}},{key:"_decodeChangeAttributeMetadataCommand",value:function(e){v("Codec.decodeChangeAttributeMetadataCommand"),y(e,"jsonCommand"),y(e[te],"jsonCommand[ATTRIBUTE_ID]"),y(e.n,"jsonCommand[NAME]");var t=new pe;return t.attributeId=e[te],t.metadataName=e.n,t.value=e.v,t}},{key:"_encodeCreateContextCommand",value:function(e){v("Codec.encodeCreateContextCommand"),y(e,"command");var t={};return t.id=Q,t}},{key:"_decodeCreateContextCommand",value:function(e){return v("Codec.decodeCreateContextCommand"),y(e,"jsonCommand"),new ve}},{key:"_encodeCreateControllerCommand",value:function(e){v("Codec._encodeCreateControllerCommand"),y(e,"command"),y(e.controllerName,"command.controllerName");var t={};return t.id=X,t.n=e.controllerName,t[re]=e.parentControllerId,t}},{key:"_decodeCreateControllerCommand",value:function(e){v("Codec._decodeCreateControllerCommand"),y(e,"jsonCommand"),y(e.n,"jsonCommand[NAME]"),y(e[re],"jsonCommand[CONTROLLER_ID]");var t=new me;return t.controllerName=e.n,t.parentControllerId=e[re],t}},{key:"_encodeCreatePresentationModelCommand",value:function(e){v("Codec.encodeCreatePresentationModelCommand"),y(e,"command"),y(e.pmId,"command.pmId"),y(e.pmType,"command.pmType");var t={};return t.id=Y,t[ne]=e.pmId,t.t=e.pmType,t.a=e.attributes.map(function(e){var t={};return t.n=e.propertyName,t[te]=e.id,p(e.value)&&(t.v=e.value),t}),t}},{key:"_decodeCreatePresentationModelCommand",value:function(e){v("Codec.decodeCreatePresentationModelCommand"),y(e,"jsonCommand"),y(e[ne],"jsonCommand[PM_ID]"),y(e.t,"jsonCommand[PM_TYPE]");var t=new Ce;return t.pmId=e[ne],t.pmType=e.t,t.attributes=e.a.map(function(e){return{propertyName:e.n,id:e[te],value:p(e.v)?e.v:null}}),t}},{key:"_encodeDeletePresentationModelCommand",value:function(e){v("Codec._encodeDeletePresentationModelCommand"),y(e,"command"),y(e.pmId,"command.pmId");var t={};return t.id=W,t[ne]=e.pmId,t}},{key:"_decodeDeletePresentationModelCommand",value:function(e){v("Codec._decodeDeletePresentationModelCommand"),y(e,"jsonCommand"),y(e[ne],"jsonCommand[PM_ID]");var t=new Ee;return t.pmId=e[ne],t}},{key:"_encodeDestroyContextCommand",value:function(e){v("Codec._encodeDestroyContextCommand"),y(e,"command");var t={};return t.id=K,t}},{key:"_decodeDestroyContextCommand",value:function(e){return v("Codec._decodeDestroyContextCommand"),y(e,"jsonCommand"),new we}},{key:"_encodeDestroyControllerCommand",value:function(e){v("Codec._encodeDestroyControllerCommand"),y(e,"command"),y(e.controllerId,"command.controllerId");var t={};return t.id=z,t[re]=e.controllerId,t}},{key:"_decodeDestroyControllerCommand",value:function(e){v("Codec._decodeDestroyControllerCommand"),y(e,"jsonCommand"),y(e[re],"jsonCommand[CONTROLLER_ID]");var t=new Te;return t.controllerId=e[re],t}},{key:"_encodeInterruptLongPollCommand",value:function(e){v("Codec._encodeInterruptLongPollCommand"),y(e,"command");var t={};return t.id=Z,t}},{key:"_decodeInterruptLongPollCommand",value:function(e){return v("Codec._decodeInterruptLongPollCommand"),y(e,"jsonCommand"),new ke}},{key:"_encodePresentationModelDeletedCommand",value:function(e){v("Codec._encodePresentationModelDeletedCommand"),y(e,"command"),y(e.pmId,"command.pmId");var t={};return t.id=J,t[ne]=e.pmId,t}},{key:"_decodePresentationModelDeletedCommand",value:function(e){v("Codec._decodePresentationModelDeletedCommand"),y(e,"jsonCommand"),y(e[ne],"jsonCommand[PM_ID]");var t=new Pe;return t.pmId=e[ne],t}},{key:"_encodeStartLongPollCommand",value:function(e){v("Codec._encodeStartLongPollCommand"),y(e,"command");var t={};return t.id=$,t}},{key:"_decodeStartLongPollCommand",value:function(e){return v("Codec._decodeStartLongPollCommand"),y(e,"jsonCommand"),new Oe}},{key:"_encodeValueChangedCommand",value:function(e){v("Codec.encodeValueChangedCommand"),y(e,"command"),y(e.attributeId,"command.attributeId");var t={};return t.id=ee,t[te]=e.attributeId,p(e.newValue)&&(t.v=e.newValue),t}},{key:"_decodeValueChangedCommand",value:function(e){v("Codec.decodeValueChangedCommand"),y(e,"jsonCommand"),y(e[te],"jsonCommand[ATTRIBUTE_ID]");var t=new ue;return t.attributeId=e[te],p(e.v)?t.newValue=e.v:t.newValue=null,t}},{key:"encode",value:function(e){v("Codec.encode"),y(e,"commands");var t=this;return JSON.stringify(e.map(function(e){if(e.id===V)return t._encodeAttributeMetadataChangedCommand(e);if(e.id===q)return t._encodeCallActionCommand(e);if(e.id===F)return t._encodeChangeAttributeMetadataCommand(e);if(e.id===Q)return t._encodeCreateContextCommand(e);if(e.id===X)return t._encodeCreateControllerCommand(e);if(e.id===Y)return t._encodeCreatePresentationModelCommand(e);if(e.id===W)return t._encodeDeletePresentationModelCommand(e);if(e.id===K)return t._encodeDestroyContextCommand(e);if(e.id===z)return t._encodeDestroyControllerCommand(e);if(e.id===Z)return t._encodeInterruptLongPollCommand(e);if(e.id===J)return t._encodePresentationModelDeletedCommand(e);if(e.id===$)return t._encodeStartLongPollCommand(e);if(e.id===ee)return t._encodeValueChangedCommand(e);throw new De("Command of type "+e.id+" can not be handled")}))}},{key:"decode",value:function(e){if(v("Codec.decode"),y(e,"transmitted"),"string"!==He(e))throw new De("Can not decode data that is not of type string");var t=this;return JSON.parse(e).map(function(e){if(e.id===V)return t._decodeAttributeMetadataChangedCommand(e);if(e.id===q)return t._decodeCallActionCommand(e);if(e.id===F)return t._decodeChangeAttributeMetadataCommand(e);if(e.id===Q)return t._decodeCreateContextCommand(e);if(e.id===X)return t._decodeCreateControllerCommand(e);if(e.id===Y)return t._decodeCreatePresentationModelCommand(e);if(e.id===W)return t._decodeDeletePresentationModelCommand(e);if(e.id===K)return t._decodeDestroyContextCommand(e);if(e.id===z)return t._decodeDestroyControllerCommand(e);if(e.id===Z)return t._decodeInterruptLongPollCommand(e);if(e.id===J)return t._decodePresentationModelDeletedCommand(e);if(e.id===$)return t._decodeStartLongPollCommand(e);if(e.id===ee)return t._decodeValueChangedCommand(e);throw new De("Command of type "+e.id+" can not be handled")})}}],(n=null)&&Be(t.prototype,n),r&&Be(t,r),e}();function Ue(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var xe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventHandlers=[]}var t,n,r;return t=e,(n=[{key:"onEvent",value:function(e){this.eventHandlers.push(e)}},{key:"trigger",value:function(t){this.eventHandlers.forEach(function(e){return e(t)})}}])&&Ue(t.prototype,n),r&&Ue(t,r),e}();function je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ve=0,qe=function(){function r(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.id=e,this.presentationModelType=t,this.attributes=[],this.clientSideOnly=!1,this.dirty=!1,this.id=void 0!==e&&null!=e?e:(Ve++).toString(),this.invalidBus=new xe,this.dirtyValueChangeBus=new xe}var e,t,n;return e=r,(t=[{key:"copy",value:function(){var n=new r(null,this.presentationModelType);return n.clientSideOnly=!0,this.getAttributes().forEach(function(e){var t=e.copy();n.addAttribute(t)}),n}},{key:"addAttributes",value:function(e){var t=this;!e||e.length<1||e.forEach(function(e){t.addAttribute(e)})}},{key:"addAttribute",value:function(e){var t=this;if(e&&!(-1<this.attributes.indexOf(e))){if(this.findAttributeByPropertyName(e.propertyName))throw new Error("There already is an attribute with property name: "+e.propertyName+" in presentation model with id: "+this.id);if(e.getQualifier()&&this.findAttributeByQualifier(e.getQualifier()))throw new Error("There already is an attribute with qualifier: "+e.getQualifier()+" in presentation model with id: "+this.id);e.setPresentationModel(this),this.attributes.push(e),e.onValueChange(function(){t.invalidBus.trigger({source:t})})}}},{key:"onInvalidated",value:function(e){this.invalidBus.onEvent(e)}},{key:"getAttributes",value:function(){return this.attributes.slice(0)}},{key:"getAt",value:function(e){return this.findAttributeByPropertyName(e)}},{key:"findAllAttributesByPropertyName",value:function(t){var n=[];return t?(this.attributes.forEach(function(e){e.propertyName==t&&n.push(e)}),n):null}},{key:"findAttributeByPropertyName",value:function(e){if(!e)return null;for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].propertyName==e)return this.attributes[t];return null}},{key:"findAttributeByQualifier",value:function(e){if(!e)return null;for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].getQualifier()==e)return this.attributes[t];return null}},{key:"findAttributeById",value:function(e){if(!e)return null;for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].id==e)return this.attributes[t];return null}},{key:"syncWith",value:function(n){this.attributes.forEach(function(e){var t=n.getAt(e.propertyName);t&&e.syncWith(t)})}}])&&je(e.prototype,t),n&&je(e,n),r}();function Fe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Qe=function(){function o(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:50;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.commandQueue=[],this.currentlySending=!1,this.pushEnabled=!1,this.waiting=!1,this.transmitter=e,this.clientDolphin=t,this.slackMS=n,this.codec=new Ge,this.commandBatcher=new ae(!0,r)}var e,t,n;return e=o,(t=[{key:"setCommandBatcher",value:function(e){this.commandBatcher=e}},{key:"setPushEnabled",value:function(e){this.pushEnabled=e}},{key:"setPushListener",value:function(e){this.pushListener=e}},{key:"setReleaseCommand",value:function(e){this.releaseCommand=e}},{key:"send",value:function(e,t){this.commandQueue.push({command:e,handler:t}),this.currentlySending?this.release():this.doSendNext()}},{key:"doSendNext",value:function(){var r=this;if(this.commandQueue.length<1){if(!this.pushEnabled)return void(this.currentlySending=!1);this.enqueuePushCommand()}this.currentlySending=!0;var e=this.commandBatcher.batch(this.commandQueue);if(0<e.length){var t=e[e.length-1].handler,n=e.map(function(e){return e.command});this.transmitter.transmit(n,function(e){var n=[];e.forEach(function(e){var t=r.handle(e);t&&n.push(t)}),t&&t.onFinished(n),setTimeout(function(){return r.doSendNext()},r.slackMS)},function(e){t.onError(e)})}else setTimeout(function(){return r.doSendNext()},this.slackMS)}},{key:"handle",value:function(e){return"DeletePresentationModel"===e.id?this.handleDeletePresentationModelCommand(e):"CreatePresentationModel"===e.id?this.handleCreatePresentationModelCommand(e):"ValueChanged"===e.id?this.handleValueChangedCommand(e):"AttributeMetadataChanged"===e.id?this.handleAttributeMetadataChangedCommand(e):(o.LOGGER.error("Cannot handle, unknown command "+e),null)}},{key:"handleDeletePresentationModelCommand",value:function(e){var t=this.clientDolphin.findPresentationModelById(e.pmId);return t?(this.clientDolphin.getClientModelStore().deletePresentationModel(t,!0),t):null}},{key:"handleCreatePresentationModelCommand",value:function(e){var n=this;if(this.clientDolphin.getClientModelStore().containsPresentationModel(e.pmId))throw new Error("There already is a presentation model with id "+e.pmId+"  known to the client.");var r=[];e.attributes.forEach(function(e){var t=n.clientDolphin.attribute(e.propertyName,e.qualifier,e.value);e.id&&e.id.match(".*S$")&&(t.id=e.id),r.push(t)});var t=new qe(e.pmId,e.pmType);return t.addAttributes(r),e.clientSideOnly&&(t.clientSideOnly=!0),this.clientDolphin.getClientModelStore().add(t,!1),this.clientDolphin.updatePresentationModelQualifier(t),t}},{key:"handleValueChangedCommand",value:function(e){var t=this.clientDolphin.getClientModelStore().findAttributeById(e.attributeId);return t?t.getValue()===e.newValue||t.setValueFromServer(e.newValue):o.LOGGER.error("attribute with id "+e.attributeId+" not found, cannot update to new value "+e.newValue),null}},{key:"handleAttributeMetadataChangedCommand",value:function(e){var t=this.clientDolphin.getClientModelStore().findAttributeById(e.attributeId);return t&&(t[e.metadataName]=e.value),null}},{key:"listen",value:function(){this.pushEnabled&&(this.waiting||this.currentlySending||this.doSendNext())}},{key:"enqueuePushCommand",value:function(){var e=this;this.waiting=!0,this.commandQueue.push({command:this.pushListener,handler:{onFinished:function(){e.waiting=!1},onFinishedData:null}})}},{key:"release",value:function(){this.waiting&&(this.waiting=!1,this.transmitter.signal(this.releaseCommand))}}])&&Fe(e.prototype,t),n&&Fe(e,n),o}();function Xe(e){return(Xe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ye(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Qe.LOGGER=m.getLogger("ClientConnector");var We=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.propertyName=e,this.id=r.clientAttributeInstanceCount+++"C",this.valueChangeBus=new xe,this.qualifierChangeBus=new xe,this.setValue(n),this.setQualifier(t)}var e,t,n;return e=r,n=[{key:"checkValue",value:function(e){if(null==e||void 0===e)return null;var t=e;(t instanceof String||t instanceof Boolean||t instanceof Number)&&(t=e.valueOf()),t instanceof r&&(r.LOGGER.warn("An Attribute may not itself contain an attribute as a value. Assuming you forgot to call value."),t=this.checkValue(e.value));var n=!1;if((-1<this.SUPPORTED_VALUE_TYPES.indexOf(Xe(t))||t instanceof Date)&&(n=!0),!n)throw new Error("Attribute values of this type are not allowed: "+Xe(e));return t}}],(t=[{key:"copy",value:function(){return new r(this.propertyName,this.getQualifier(),this.getValue())}},{key:"setPresentationModel",value:function(e){if(this.presentationModel)throw new Error("You can not set a presentation model for an attribute that is already bound.");this.presentationModel=e}},{key:"getPresentationModel",value:function(){return this.presentationModel}},{key:"getValue",value:function(){return this.value}},{key:"setValueFromServer",value:function(e){var t=r.checkValue(e);if(this.value!==t){var n=this.value;this.value=t,this.valueChangeBus.trigger({oldValue:n,newValue:t,sendToServer:!1})}}},{key:"setValue",value:function(e){var t=r.checkValue(e);if(this.value!==t){var n=this.value;this.value=t,this.valueChangeBus.trigger({oldValue:n,newValue:t,sendToServer:!0})}}},{key:"setQualifier",value:function(e){if(this.qualifier!==e){var t=this.qualifier;this.qualifier=e,this.qualifierChangeBus.trigger({oldValue:t,newValue:e}),this.valueChangeBus.trigger({oldValue:this.value,newValue:this.value,sendToServer:!1})}}},{key:"getQualifier",value:function(){return this.qualifier}},{key:"onValueChange",value:function(e){this.valueChangeBus.onEvent(e),e({oldValue:this.value,newValue:this.value,sendToServer:!1})}},{key:"onQualifierChange",value:function(e){this.qualifierChangeBus.onEvent(e)}},{key:"syncWith",value:function(e){e&&(this.setQualifier(e.getQualifier()),this.setValue(e.value))}}])&&Ye(e.prototype,t),n&&Ye(e,n),r}();function Ke(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}We.LOGGER=m.getLogger("ClientAttribute"),We.SUPPORTED_VALUE_TYPES=["string","number","boolean"],We.clientAttributeInstanceCount=0;var ze=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"setClientConnector",value:function(e){this.clientConnector=e}},{key:"getClientConnector",value:function(){return this.clientConnector}},{key:"send",value:function(e,t){this.clientConnector.send(e,t)}},{key:"attribute",value:function(e,t,n){return new We(e,t,n)}},{key:"presentationModel",value:function(e,t){for(var n=new qe(e,t),r=arguments.length,o=new Array(2<r?r-2:0),a=2;a<r;a++)o[a-2]=arguments[a];return o&&0<o.length&&o.forEach(function(e){n.addAttribute(e)}),this.getClientModelStore().add(n,!0),n}},{key:"setClientModelStore",value:function(e){this.clientModelStore=e}},{key:"getClientModelStore",value:function(){return this.clientModelStore}},{key:"listPresentationModelIds",value:function(){return this.getClientModelStore().listPresentationModelIds()}},{key:"listPresentationModels",value:function(){return this.getClientModelStore().listPresentationModels()}},{key:"findAllPresentationModelByType",value:function(e){return this.getClientModelStore().findAllPresentationModelByType(e)}},{key:"getAt",value:function(e){return this.findPresentationModelById(e)}},{key:"findPresentationModelById",value:function(e){return this.getClientModelStore().findPresentationModelById(e)}},{key:"deletePresentationModel",value:function(e){this.getClientModelStore().deletePresentationModel(e,!0)}},{key:"updatePresentationModelQualifier",value:function(e){var t=this;e.getAttributes().forEach(function(e){t.updateAttributeQualifier(e)})}},{key:"updateAttributeQualifier",value:function(t){t.getQualifier()&&this.getClientModelStore().findAllAttributesByQualifier(t.getQualifier()).forEach(function(e){e.setValue(t.getValue())})}},{key:"startPushListening",value:function(e,t){var n=this;this.clientConnector.setPushListener(e),this.clientConnector.setReleaseCommand(t),this.clientConnector.setPushEnabled(!0),setTimeout(function(){n.clientConnector.listen()},0)}},{key:"stopPushListening",value:function(){this.clientConnector.setPushEnabled(!1)}}])&&Ke(t.prototype,n),r&&Ke(t,r),e}();var Ze=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};function Je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Ze.QUALIFIER_PROPERTY="qualifier",Ze.VALUE="value";var $e=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"createCreateContextCommand",value:function(){return new ve}},{key:"createCreateControllerCommand",value:function(e,t){var n=new me;return n.init(e,t),n}},{key:"createCallActionCommand",value:function(e,t,n){var r=new fe;return r.init(e,t,n),r}},{key:"createDestroyControllerCommand",value:function(e){var t=new Te;return t.init(e),t}},{key:"createDestroyContextCommand",value:function(){return new we}},{key:"createStartLongPollCommand",value:function(){return new Oe}},{key:"createInterruptLongPollCommand",value:function(){return new ke}},{key:"createCreatePresentationModelCommand",value:function(e){var t=new Ce;return t.init(e),t}},{key:"createDeletePresentationModelCommand",value:function(e){var t=new Ee;return t.init(e),t}},{key:"createPresentationModelDeletedCommand",value:function(e){var t=new Pe;return t.init(e),t}},{key:"createValueChangedCommand",value:function(e,t){var n=new ue;return n.init(e,t),n}},{key:"createChangeAttributeMetadataCommand",value:function(e,t,n){var r=new pe;return r.init(e,t,n),r}},{key:"createAttributeMetadataChangedCommand",value:function(e,t,n){var r=new ce;return r.init(e,t,n),r}}],(n=null)&&Je(t.prototype,n),r&&Je(t,r),e}();function et(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var tt=function(){function o(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.clientDolphin=e,this.presentationModels=new Map,this.presentationModelsPerType=new Map,this.attributesPerId=new Map,this.attributesPerQualifier=new Map,this.modelStoreChangeBus=new xe}var e,t,n;return e=o,(t=[{key:"getClientDolphin",value:function(){return this.clientDolphin}},{key:"registerAttribute",value:function(n){var r=this;this.addAttributeById(n),n.getQualifier()&&this.addAttributeByQualifier(n),n.onValueChange(function(e){if(e.newValue!==e.oldValue&&!0===e.sendToServer){var t=$e.createValueChangedCommand(n.id,e.newValue);r.clientDolphin.getClientConnector().send(t,null)}n.getQualifier()&&r.findAttributesByFilter(function(e){return e!==n&&e.getQualifier()===n.getQualifier()}).forEach(function(e){e.setValue(n.getValue())})}),n.onQualifierChange(function(e){r.clientDolphin.getClientConnector().send($e.createChangeAttributeMetadataCommand(n.id,Ze.QUALIFIER_PROPERTY,e.newValue),null)})}},{key:"add",value:function(e){var t=this,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(!e)return!1;this.presentationModels.has(e.id)&&o.LOGGER.error("There already is a PM with id "+e.id);var r=!1;if(!this.presentationModels.has(e.id)){if(this.presentationModels.set(e.id,e),this.addPresentationModelByType(e),n)this.clientDolphin.getClientConnector().send($e.createCreatePresentationModelCommand(e),null);e.getAttributes().forEach(function(e){t.registerAttribute(e)}),this.modelStoreChangeBus.trigger({eventType:"ADDED",clientPresentationModel:e}),r=!0}return r}},{key:"remove",value:function(e){var t=this;if(!e)return!1;var n=!1;return this.presentationModels.has(e.id)&&(this.removePresentationModelByType(e),this.presentationModels.delete(e.id),e.getAttributes().forEach(function(e){t.removeAttributeById(e),e.getQualifier()&&t.removeAttributeByQualifier(e)}),this.modelStoreChangeBus.trigger({eventType:ie,clientPresentationModel:e}),n=!0),n}},{key:"findAttributesByFilter",value:function(t){var n=[];return this.presentationModels.forEach(function(e){e.getAttributes().forEach(function(e){t(e)&&n.push(e)})}),n}},{key:"addPresentationModelByType",value:function(e){if(e){var t=e.presentationModelType;if(t){var n=this.presentationModelsPerType.get(t);n||(n=[],this.presentationModelsPerType.set(t,n)),-1<n.indexOf(e)||n.push(e)}}}},{key:"removePresentationModelByType",value:function(e){if(e&&e.presentationModelType){var t=this.presentationModelsPerType.get(e.presentationModelType);t&&(-1<t.length&&t.splice(t.indexOf(e),1),0===t.length&&this.presentationModelsPerType.delete(e.presentationModelType))}}},{key:"listPresentationModelIds",value:function(){for(var e=[],t=this.presentationModels.keys(),n=t.next();!n.done;)e.push(n.value),n=t.next();return e}},{key:"listPresentationModels",value:function(){for(var e=[],t=this.presentationModels.values(),n=t.next();!n.done;)e.push(n.value),n=t.next();return e}},{key:"findPresentationModelById",value:function(e){return this.presentationModels.get(e)}},{key:"findAllPresentationModelByType",value:function(e){return e&&this.presentationModelsPerType.has(e)?this.presentationModelsPerType.get(e).slice(0):[]}},{key:"deletePresentationModel",value:function(e,t){if(e&&this.containsPresentationModel(e.id)){if(this.remove(e),!t||e.clientSideOnly)return;this.clientDolphin.getClientConnector().send($e.createPresentationModelDeletedCommand(e.id),null)}}},{key:"containsPresentationModel",value:function(e){return this.presentationModels.has(e)}},{key:"addAttributeById",value:function(e){e&&!this.attributesPerId.has(e.id)&&this.attributesPerId.set(e.id,e)}},{key:"removeAttributeById",value:function(e){e&&this.attributesPerId.has(e.id)&&this.attributesPerId.delete(e.id)}},{key:"findAttributeById",value:function(e){return this.attributesPerId.get(e)}},{key:"addAttributeByQualifier",value:function(e){if(e&&e.getQualifier()){var t=this.attributesPerQualifier.get(e.getQualifier());t||(t=[],this.attributesPerQualifier.set(e.getQualifier(),t)),-1<t.indexOf(e)||t.push(e)}}},{key:"removeAttributeByQualifier",value:function(e){if(e&&e.getQualifier()){var t=this.attributesPerQualifier.get(e.getQualifier());t&&(-1<t.length&&t.splice(t.indexOf(e),1),0===t.length&&this.attributesPerQualifier.delete(e.getQualifier()))}}},{key:"findAllAttributesByQualifier",value:function(e){return e&&this.attributesPerQualifier.has(e)?this.attributesPerQualifier.get(e).slice(0):[]}},{key:"onModelStoreChange",value:function(e){this.modelStoreChangeBus.onEvent(e)}},{key:"onModelStoreChangeForType",value:function(t,n){this.modelStoreChangeBus.onEvent(function(e){e.clientPresentationModel.presentationModelType==t&&n(e)})}}])&&et(e.prototype,t),n&&et(e,n),o}();function nt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}tt.LOGGER=m.getLogger("ClientModelStore");var rt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"transmit",value:function(e,t){t([])}},{key:"signal",value:function(){}},{key:"reset",value:function(){}}])&&nt(t.prototype,n),r&&nt(t,r),e}();function ot(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var at=function(){function n(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.slackMS=300,this.maxBatchSize=50,this.transmitter=null}var e,t,r;return e=n,(t=[{key:"withSlackMS",value:function(e){return this.slackMS=e,this}},{key:"withMaxBatchSize",value:function(e){return this.maxBatchSize=e,this}},{key:"withTransmitter",value:function(e){return this.transmitter=e,this}},{key:"build",value:function(){var e,t=new ze;return e=this.transmitter?this.transmitter:new rt,t.setClientConnector(new Qe(e,t,this.slackMS,this.maxBatchSize)),t.setClientModelStore(new tt(t)),n.LOGGER.debug("Remoting client initialized",t,e),t}}])&&ot(e.prototype,t),r&&ot(e,r),n}();at.LOGGER=m.getLogger("DolphinBuilder");var it=new at;function lt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ut="@@@ R_BEAN @@@",st="@@@ CONTROLLER_ACTION_CALL_BEAN @@@",ct="@@@ SOURCE_SYSTEM @@@",dt=function(){function a(e,t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),v("Connector(url, dolphin, classRepository, config)"),y(e,"url"),y(t,"dolphin"),y(n,"classRepository");var o=this;this.dolphin=t,this.config=r,this.classRepository=n,this.highlanderPMResolver=function(){},this.highlanderPMPromise=new Promise(function(e){o.highlanderPMResolver=e}),t.getClientModelStore().onModelStoreChange(function(e){var t=e.clientPresentationModel,n=t.findAttributeByPropertyName(ct);p(n)&&"server"===n.value&&("ADDED"===e.eventType?o.onModelAdded(t):e.eventType===ie&&o.onModelRemoved(t))})}var e,t,n;return e=a,(t=[{key:"connect",value:function(){this.dolphin.startPushListening($e.createStartLongPollCommand(),$e.createInterruptLongPollCommand())}},{key:"onModelAdded",value:function(e){switch(v("Connector.onModelAdded(model)"),y(e,"model"),e.presentationModelType){case st:break;case ut:this.classRepository.registerClass(e);break;case"@@@ HIGHLANDER_BEAN @@@":this.highlanderPMResolver(e);break;case"@R:LS@":this.classRepository.spliceListEntry(e),this.dolphin.deletePresentationModel(e);break;default:this.classRepository.load(e)}}},{key:"onModelRemoved",value:function(e){switch(v("Connector.onModelRemoved(model)"),y(e,"model"),e.presentationModelType){case ut:this.classRepository.unregisterClass(e);break;case"@R:LS@":break;default:this.classRepository.unload(e)}}},{key:"invoke",value:function(e){v("Connector.invoke(command)"),y(e,"command");var r=this.dolphin;return new Promise(function(t,n){r.send(e,{onFinished:function(e){t(e)},onError:function(e){n(e)}})})}},{key:"getHighlanderPM",value:function(){return this.highlanderPMPromise}}])&&lt(e.prototype,t),n&&lt(e,n),a}();function ft(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ht=function(){function l(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),v("BeanManager(classRepository)"),y(e,"classRepository"),this.classRepository=e,this.addedHandlers=new Map,this.removedHandlers=new Map,this.updatedHandlers=new Map,this.arrayUpdatedHandlers=new Map,this.allAddedHandlers=[],this.allRemovedHandlers=[],this.allUpdatedHandlers=[],this.allArrayUpdatedHandlers=[],this._handleBeanAdded=this._handleBeanAdded.bind(this),this._handleBeanRemoved=this._handleBeanRemoved.bind(this),this._handleBeanUpdate=this._handleBeanUpdate.bind(this),this._handleArrayUpdate=this._handleArrayUpdate.bind(this),this.classRepository.onBeanAdded(this._handleBeanAdded),this.classRepository.onBeanRemoved(this._handleBeanRemoved),this.classRepository.onBeanUpdate(this._handleBeanUpdate),this.classRepository.onArrayUpdate(this._handleArrayUpdate)}var e,t,n;return e=l,(t=[{key:"_handleBeanAdded",value:function(t,n){var e=this.addedHandlers.get(t);p(e)&&e.forEach(function(e){try{e(n)}catch(e){l.LOGGER.error("An exception occurred while calling an onBeanAdded-handler for type",t,e)}}),this.allAddedHandlers.forEach(function(e){try{e(n)}catch(e){l.LOGGER.error("An exception occurred while calling a general onBeanAdded-handler",e)}})}},{key:"_handleBeanRemoved",value:function(t,n){var e=this.removedHandlers.get(t);p(e)&&e.forEach(function(e){try{e(n)}catch(e){l.LOGGER.error("An exception occurred while calling an onBeanRemoved-handler for type",t,e)}}),this.allRemovedHandlers.forEach(function(e){try{e(n)}catch(e){l.LOGGER.error("An exception occurred while calling a general onBeanRemoved-handler",e)}})}},{key:"_handleArrayUpdate",value:function(t,n,r,o,a,i){var e=this.arrayUpdatedHandlers.get(t);p(e)&&e.forEach(function(e){try{e(n,r,o,a,i)}catch(e){l.LOGGER.error("An exception occurred while calling an onArrayUpdate-handler for type",t,e)}}),this.allArrayUpdatedHandlers.forEach(function(e){try{e(n,r,o,a,i)}catch(e){l.LOGGER.error("An exception occurred while calling a general onArrayUpdate-handler",e)}})}},{key:"_handleBeanUpdate",value:function(t,n,r,o,a){var e=this.updatedHandlers.get(t);p(e)&&e.forEach(function(e){try{e(n,r,o,a)}catch(e){l.LOGGER.error("An exception occurred while calling an onBeanUpdate-handler for type",t,e)}}),this.allUpdatedHandlers.forEach(function(e){try{e(n,r,o,a)}catch(e){l.LOGGER.error("An exception occurred while calling a general onBeanUpdate-handler",e)}})}},{key:"notifyBeanChange",value:function(e,t,n){return v("BeanManager.notifyBeanChange(bean, propertyName, newValue)"),y(e,"bean"),y(t,"propertyName"),this.classRepository.notifyBeanChange(e,t,n)}},{key:"notifyArrayChange",value:function(e,t,n,r,o){v("BeanManager.notifyArrayChange(bean, propertyName, index, count, removedElements)"),y(e,"bean"),y(t,"propertyName"),y(n,"index"),y(r,"count"),y(o,"removedElements"),this.classRepository.notifyArrayChange(e,t,n,r,o)}},{key:"isManaged",value:function(e){throw v("BeanManager.isManaged(bean)"),y(e,"bean"),new Error("Not implemented yet")}},{key:"create",value:function(e){throw v("BeanManager.create(type)"),y(e,"type"),new Error("Not implemented yet")}},{key:"add",value:function(e,t){throw v("BeanManager.add(type, bean)"),y(e,"type"),y(t,"bean"),new Error("Not implemented yet")}},{key:"addAll",value:function(e,t){throw v("BeanManager.addAll(type, collection)"),y(e,"type"),y(t,"collection"),new Error("Not implemented yet")}},{key:"remove",value:function(e){throw v("BeanManager.remove(bean)"),y(e,"bean"),new Error("Not implemented yet")}},{key:"removeAll",value:function(e){throw v("BeanManager.removeAll(collection)"),y(e,"collection"),new Error("Not implemented yet")}},{key:"removeIf",value:function(e){throw v("BeanManager.removeIf(predicate)"),y(e,"predicate"),new Error("Not implemented yet")}},{key:"onAdded",value:function(t,n){var r=this;if(p(n)){v("BeanManager.onAdded(type, eventHandler)"),y(t,"type"),y(n,"eventHandler");var e=this.addedHandlers.get(t);return p(e)||(e=[]),this.addedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.addedHandlers.get(t);p(e)&&r.addedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return n=t,v("BeanManager.onAdded(eventHandler)"),y(n,"eventHandler"),this.allAddedHandlers=this.allAddedHandlers.concat(n),{unsubscribe:function(){r.allAddedHandlers=r.allAddedHandlers.filter(function(e){return e!==n})}}}},{key:"onRemoved",value:function(t,n){var r=this;if(p(n)){v("BeanManager.onRemoved(type, eventHandler)"),y(t,"type"),y(n,"eventHandler");var e=this.removedHandlers.get(t);return p(e)||(e=[]),this.removedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.removedHandlers.get(t);p(e)&&r.removedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return n=t,v("BeanManager.onRemoved(eventHandler)"),y(n,"eventHandler"),this.allRemovedHandlers=this.allRemovedHandlers.concat(n),{unsubscribe:function(){r.allRemovedHandlers=r.allRemovedHandlers.filter(function(e){return e!==n})}}}},{key:"onBeanUpdate",value:function(t,n){var r=this;if(p(n)){v("BeanManager.onBeanUpdate(type, eventHandler)"),y(t,"type"),y(n,"eventHandler");var e=this.updatedHandlers.get(t);return p(e)||(e=[]),this.updatedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.updatedHandlers.get(t);p(e)&&r.updatedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return n=t,v("BeanManager.onBeanUpdate(eventHandler)"),y(n,"eventHandler"),this.allUpdatedHandlers=this.allUpdatedHandlers.concat(n),{unsubscribe:function(){r.allUpdatedHandlers=r.allUpdatedHandlers.filter(function(e){return e!==n})}}}},{key:"onArrayUpdate",value:function(t,n){var r=this;if(p(n)){v("BeanManager.onArrayUpdate(type, eventHandler)"),y(t,"type"),y(n,"eventHandler");var e=this.arrayUpdatedHandlers.get(t);return p(e)||(e=[]),this.arrayUpdatedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.arrayUpdatedHandlers.get(t);p(e)&&r.arrayUpdatedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return n=t,v("BeanManager.onArrayUpdate(eventHandler)"),y(n,"eventHandler"),this.allArrayUpdatedHandlers=this.allArrayUpdatedHandlers.concat(n),{unsubscribe:function(){r.allArrayUpdatedHandlers=r.allArrayUpdatedHandlers.filter(function(e){return e!==n})}}}}])&&ft(e.prototype,t),n&&ft(e,n),l}();function pt(e){return(pt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}ht.LOGGER=m.getLogger("BeanManager");var yt=function(){function f(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),v("ClassRepository(dolphin)"),y(e,"dolphin"),this.dolphin=e,this.classes=new Map,this.beanFromDolphin=new Map,this.beanToDolphin=new Map,this.classInfos=new Map,this.beanAddedHandlers=[],this.beanRemovedHandlers=[],this.propertyUpdateHandlers=[],this.arrayUpdateHandlers=[],this.blocked=null}var e,t,n;return e=f,(t=[{key:"sendListSplice",value:function(n,e,t,r,o,a){var i=n.dolphin,l=i.findPresentationModelById(e);if(p(l)){var u=n.classes.get(l.presentationModelType)[t];if(p(u)){var s=[i.attribute("@@@ SOURCE_SYSTEM @@@",null,"client"),i.attribute("source",null,e),i.attribute("attribute",null,t),i.attribute("from",null,r),i.attribute("to",null,o),i.attribute("count",null,a.length)];a.forEach(function(e,t){s.push(i.attribute(t.toString(),null,f.toDolphin(n,u,e)))}),i.presentationModel.apply(i,[null,"@DP:LS@"].concat(s))}}}},{key:"validateList",value:function(e,t,n,r){p(n[r])||e.propertyUpdateHandlers.forEach(function(e){try{e(t,n,r,[],void 0)}catch(e){f.LOGGER.error("An exception occurred while calling an onBeanUpdate-handler",e)}})}},{key:"block",value:function(e,t){if(p(this.blocked))throw new Error("Trying to create a block while another block exists");this.blocked={bean:e,propertyName:t}}},{key:"isBlocked",value:function(e,t){return p(this.blocked)&&this.blocked.bean===e&&this.blocked.propertyName===t}},{key:"unblock",value:function(){this.blocked=null}},{key:"notifyBeanChange",value:function(e,t,n){v("ClassRepository.notifyBeanChange(bean, propertyName, newValue)"),y(e,"bean"),y(t,"propertyName");var r=this.beanToDolphin.get(e);if(p(r)){var o=this.dolphin.findPresentationModelById(r);if(p(o)){var a=this.classes.get(o.presentationModelType)[t],i=o.findAttributeByPropertyName(t);if(p(a)&&p(i)){var l=i.getValue();return i.setValue(f.toDolphin(this,a,n)),f.fromDolphin(this,a,l)}}}}},{key:"notifyArrayChange",value:function(e,t,n,r,o){if(v("ClassRepository.notifyArrayChange(bean, propertyName, index, count, removedElements)"),y(e,"bean"),y(t,"propertyName"),y(n,"index"),y(r,"count"),y(o,"removedElements"),!this.isBlocked(e,t)){var a=this.beanToDolphin.get(e),i=e[t];if(p(a)&&p(i)){var l=Array.isArray(o)?o.length:0;this.sendListSplice(this,a,t,n,n+l,i.slice(n,n+r))}}}},{key:"onBeanAdded",value:function(e){v("ClassRepository.onBeanAdded(handler)"),y(e,"handler"),this.beanAddedHandlers.push(e)}},{key:"onBeanRemoved",value:function(e){v("ClassRepository.onBeanRemoved(handler)"),y(e,"handler"),this.beanRemovedHandlers.push(e)}},{key:"onBeanUpdate",value:function(e){v("ClassRepository.onBeanUpdate(handler)"),y(e,"handler"),this.propertyUpdateHandlers.push(e)}},{key:"onArrayUpdate",value:function(e){v("ClassRepository.onArrayUpdate(handler)"),y(e,"handler"),this.arrayUpdateHandlers.push(e)}},{key:"registerClass",value:function(e){if(v("ClassRepository.registerClass(model)"),y(e,"model"),!this.classes.has(e.id)){var t={};e.attributes.filter(function(e){return e.propertyName.search(/^@/)<0}).forEach(function(e){t[e.propertyName]=e.value}),this.classes.set(e.id,t)}}},{key:"unregisterClass",value:function(e){v("ClassRepository.unregisterClass(model)"),y(e,"model"),this.classes.delete(e.id)}},{key:"load",value:function(o){v("ClassRepository.load(model)"),y(o,"model");var a=this,i=this.classes.get(o.presentationModelType),l={};return o.attributes.filter(function(e){return e.propertyName.search(/^@/)<0}).forEach(function(r){l[r.propertyName]=null,r.onValueChange(function(e){if(e.oldValue!==e.newValue){var t=f.fromDolphin(a,i[r.propertyName],e.oldValue),n=f.fromDolphin(a,i[r.propertyName],e.newValue);a.propertyUpdateHandlers.forEach(function(e){try{e(o.presentationModelType,l,r.propertyName,n,t)}catch(e){f.LOGGER.error("An exception occurred while calling an onBeanUpdate-handler",e)}})}})}),this.beanFromDolphin.set(o.id,l),this.beanToDolphin.set(l,o.id),this.classInfos.set(o.id,i),this.beanAddedHandlers.forEach(function(e){try{e(o.presentationModelType,l)}catch(e){f.LOGGER.error("An exception occurred while calling an onBeanAdded-handler",e)}}),l}},{key:"unload",value:function(t){v("ClassRepository.unload(model)"),y(t,"model");var n=this.beanFromDolphin.get(t.id);return this.beanFromDolphin.delete(t.id),this.beanToDolphin.delete(n),this.classInfos.delete(t.id),p(n)&&this.beanRemovedHandlers.forEach(function(e){try{e(t.presentationModelType,n)}catch(e){f.LOGGER.error("An exception occurred while calling an onBeanRemoved-handler",e)}}),n}},{key:"spliceListEntry",value:function(e){v("ClassRepository.spliceListEntry(model)"),y(e,"model");var t=e.findAttributeByPropertyName("source"),n=e.findAttributeByPropertyName("attribute"),r=e.findAttributeByPropertyName("from"),o=e.findAttributeByPropertyName("to"),a=e.findAttributeByPropertyName("count");if(!(p(t)&&p(n)&&p(r)&&p(o)&&p(a)))throw new Error("Invalid list modification update received");var i=this.classInfos.get(t.value),l=this.beanFromDolphin.get(t.value);if(!p(l)||!p(i))throw new Error("Invalid list modification update received. Source bean unknown.");var u=e.presentationModelType;this.validateList(this,u,l,n.value);for(var s=[],c=null,d=0;d<a.value;d++){if(!p(c=e.findAttributeByPropertyName(d.toString())))throw new Error("Invalid list modification update received");s.push(f.fromDolphin(this,i[n.value],c.value))}try{this.block(l,n.value),this.arrayUpdateHandlers.forEach(function(e){try{e(u,l,n.value,r.value,o.value-r.value,s)}catch(e){f.LOGGER.error("An exception occurred while calling an onArrayUpdate-handler",e)}})}finally{this.unblock()}}},{key:"mapParamToDolphin",value:function(e){if(!p(e))return e;var t=pt(e);if("object"===t){if(e instanceof Date)return e.toISOString();var n=this.beanToDolphin.get(e);if(p(n))return n;throw new TypeError("Only managed remoting beans can be used")}if("string"===t||"number"===t||"boolean"===t)return e;throw new TypeError("Only managed remoting beans and primitive types can be used")}},{key:"mapDolphinToBean",value:function(e){return f.fromDolphin(this,0,e)}}])&&vt(e.prototype,t),n&&vt(e,n),f}();yt.fixType=function(e,t){switch(e){case 1:case 2:case 3:case 4:return parseInt(t);case 5:case 6:return parseFloat(t);case 7:return"true"===String(t).toLowerCase();case 8:case 10:return String(t);default:return t}},yt.fromDolphin=function(e,t,n){if(!p(n))return null;switch(t){case 0:return e.beanFromDolphin.get(String(n));case 9:case 11:case 55:case 52:case 54:return new Date(String(n));default:return yt.fixType(t,n)}},yt.toDolphin=function(e,t,n){if(!p(n))return null;switch(t){case 0:return e.beanToDolphin.get(n);case 9:case 11:case 55:case 52:case 54:return n instanceof Date?n.toISOString():n;default:return yt.fixType(t,n)}},yt.LOGGER=m.getLogger("ClassRepository");var mt=yt;function gt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ct=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),v("ControllerProxy(controllerId, model, manager)"),y(e,"controllerId"),y(t,"model"),y(n,"manager"),this.controllerId=e,this.model=t,this.manager=n,this.destroyed=!1,this.onDestroyedHandlers=new Set}var e,t,n;return e=r,(t=[{key:"getModel",value:function(){return this.model}},{key:"getId",value:function(){return this.controllerId}},{key:"invoke",value:function(e,t){if(v("ControllerProxy.invoke(name, params)"),y(e,"name"),this.destroyed)throw new Error("The controller was already destroyed");return this.manager.invokeAction(this.controllerId,e,t)}},{key:"createController",value:function(e){return this.manager._createController(e,this.getId())}},{key:"destroy",value:function(){var t=this;if(this.destroyed)throw new Error("The controller was already destroyed");return this.destroyed=!0,this.onDestroyedHandlers.forEach(function(e){try{e(t)}catch(e){r.LOGGER.error("An exception occurred while calling an onDestroyed-handler",e)}},this),this.manager.destroyController(this)}},{key:"onDestroyed",value:function(e){v("ControllerProxy.onDestroyed(handler)"),y(e,"handler");var t=this;return this.onDestroyedHandlers.add(e),{unsubscribe:function(){t.onDestroyedHandlers.delete(e)}}}}])&&gt(e.prototype,t),n&&gt(e,n),r}();function bt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Ct.LOGGER=m.getLogger("ControllerProxy");var Et="controllerId",wt="errorCode",Rt=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),v("ControllerManager(dolphin, classRepository, connector)"),y(e,"dolphin"),y(t,"classRepository"),y(n,"connector"),this.dolphin=e,this.classRepository=t,this.connector=n,this.controllers=new Set}var e,t,n;return e=r,(t=[{key:"createController",value:function(e){return this._createController(e,null)}},{key:"_createController",value:function(e,n){v("ControllerManager.createController(name)"),y(e,"name");var i=this;return new Promise(function(o,a){i.connector.getHighlanderPM().then(function(t){var r="Error creating controller: ";i.connector.invoke($e.createCreateControllerCommand(e,n)).then(function(){var n;i.getValueWithRetry(function(){return t.findAttributeByPropertyName(Et).getValue()},"Could not get an controllerID from highlanderPM.").then(function(e){return n=e,i.getValueWithRetry(function(){return t.findAttributeByPropertyName("model").getValue()},"Could not get an modelID from highlanderPM.")}).then(function(e){return i.getValueWithRetry(function(){return i.classRepository.mapDolphinToBean(e)},"Could not get an model from classRepository for ID: "+e)}).then(function(e){try{var t=new Ct(n,e,i);i.controllers.add(t),o(t)}catch(e){a(r+e)}}).catch(function(e){a(r+e)})}).catch(function(e){a(r+e)})})})}},{key:"getValueWithRetry",value:function(a,i){return new Promise(function(t,n){var r=0,o=setInterval(function(){var e=a();null==e?1e3<=++r&&(clearInterval(o),n(i+" after "+r+" retries.")):(clearInterval(o),t(e))},5)})}},{key:"invokeAction",value:function(l,u,s){v("ControllerManager.invokeAction(controllerId, actionName, params)"),y(l,"controllerId"),y(u,"actionName");var c=this;return new Promise(function(e,t){var n=[c.dolphin.attribute(ct,null,"client"),c.dolphin.attribute(wt)],r=c.dolphin.presentationModel.apply(c.dolphin,[null,st].concat(n)),o=[];if(p(s))for(var a in s)if(s.hasOwnProperty(a)){var i=c.classRepository.mapParamToDolphin(s[a]);o.push({name:a,value:i})}c.connector.invoke($e.createCallActionCommand(l,u,o)).then(function(){r.findAttributeByPropertyName(wt).getValue()?t(new Error("Server side ControllerAction "+u+" caused an error. Please see server log for details.")):e(),c.dolphin.deletePresentationModel(r)}).catch(t)})}},{key:"destroyController",value:function(r){v("ControllerManager.destroyController(controller)"),y(r,"controller");var o=this;return new Promise(function(t,n){o.connector.getHighlanderPM().then(function(e){o.controllers.delete(r),e.findAttributeByPropertyName(Et).setValue(r.controllerId),o.connector.invoke($e.createDestroyControllerCommand(r.getId())).then(t).catch(n)})})}},{key:"destroy",value:function(){var e=this.controllers,t=[];return this.controllers=new Set,e.forEach(function(e){try{t.push(e.destroy())}catch(e){}}),Promise.all(t)}}])&&bt(e.prototype,t),n&&bt(e,n),r}(),Tt=n(0),kt=n.n(Tt);function At(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Pt=function(){function o(e,t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),v("ClientContext(dolphin, beanManager, controllerManager, connector)"),y(e,"dolphin"),y(t,"beanManager"),y(n,"controllerManager"),y(r,"connector"),this.dolphin=e,this.beanManager=t,this._controllerManager=n,this._connector=r,this.connectionPromise=null,this.isConnected=!1}var e,t,n;return e=o,(t=[{key:"connect",value:function(){var n=this;return this.connectionPromise=new Promise(function(e,t){n._connector.connect(),n._connector.invoke($e.createCreateContextCommand()).then(function(){n.isConnected=!0,e()}).catch(t)}),this.connectionPromise}},{key:"onConnect",value:function(){return p(this.connectionPromise)?this.isConnected?new Promise(function(e){e()}):this.connectionPromise:this.connect()}},{key:"createController",value:function(e){return v("ClientContext.createController(name)"),y(e,"name"),this._controllerManager.createController(e)}},{key:"disconnect",value:function(){var t=this;return this.dolphin.stopPushListening(),new Promise(function(e){t._controllerManager.destroy().then(function(){t._connector.invoke($e.createDestroyContextCommand()),t.dolphin=null,t.beanManager=null,t._controllerManager=null,t._connector=null,e()})})}}])&&At(e.prototype,t),n&&At(e,n),o}();function Ot(e){return(Ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Mt(e,t){return!t||"object"!==Ot(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function It(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Lt(e,t)}function Nt(e){var r="function"==typeof Map?new Map:void 0;return(Nt=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return St(e,arguments,Dt(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Lt(n,e)})(e)}function St(e,t,n){return(St=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&Lt(o,n.prototype),o}).apply(null,arguments)}function Lt(e,t){return(Lt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Dt(e){return(Dt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}kt()(Pt.prototype);var Ht=function(e){function r(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Remoting Error",n=1<arguments.length?arguments[1]:void 0;return _t(this,r),(e=Mt(this,Dt(r).call(this,t))).detail=n||void 0,e}return It(r,Nt(Error)),r}(),Bt=function(e){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Session Error";return _t(this,t),Mt(this,Dt(t).call(this,e))}return It(t,Nt(Error)),t}();(function(e){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Http Response Error";return _t(this,t),Mt(this,Dt(t).call(this,e))}It(t,Nt(Error))})(),function(e){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Http Network Error";return _t(this,t),Mt(this,Dt(t).call(this,e))}It(t,Nt(Error))}();function Gt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ut=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,n,r;return e=t,(n=[{key:"onError",value:function(e){t.LOGGER.error(e)}}])&&Gt(e.prototype,n),r&&Gt(e,r),t}();function xt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Ut.LOGGER=m.getLogger("RemotingErrorHandler");var jt=function(){function c(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),this.url=e,this.config=t,this.client=n,this.headersInfo=p(t)?t.headersInfo:null,this.failed_attempt=0;var r=this._connectionConfig();this.maxRetry=p(r)&&p(r.maxRetry)?r.maxRetry:3,this.timeout=p(r)&&p(r.timeout)?r.timeout:5e3}var e,t,n;return e=c,(t=[{key:"_connectionConfig",value:function(){return p(this.config)?this.config.connection:null}},{key:"_handleError",value:function(e,t){var n=this._connectionConfig();(p(n)&&p(n.errorHandlers)?n.errorHandlers:[new Ut]).forEach(function(e){e.onError(t)}),e(t)}},{key:"_send",value:function(l){var u=this,s=this;return new Promise(function(t,n){if(u.client){var e=Ge.encode(l);if(c.LOGGER.isLogLevelUseable(d.DEBUG)&&!c.LOGGER.isLogLevelUseable(d.TRACE))for(var r=0;r<l.length;r++){var o=l[r];o.id===ee&&c.LOGGER.debug("send",o,e)}var a=1===l.length&&l[0].id===$,i=u.client.getService("HttpClient");i&&s.failed_attempt<=s.maxRetry?i.post(s.url).withHeadersInfo(u.headersInfo).withContent(e).readString().execute(a).then(function(e){t(e.content)}).catch(function(e){var t=e.getStatus();s.failed_attempt+=1,408===t?s._handleError(n,new Bt("PlatformHttpTransmitter: Session Timeout")):s._handleError(n,e)}):c.LOGGER.error("Cannot reach the sever")}else c.LOGGER.error("No Rico client found!")})}},{key:"transmit",value:function(e,o,a){var i=this;this._send(e).then(function(t){if(0<t.trim().length)try{var e=Ge.decode(t);o(e)}catch(e){var n="PlatformHttpTransmitter: Parse error: (Incorrect response = "+t+")";i.emit("error",new Ht(n)),a(n)}else{var r="PlatformHttpTransmitter: Empty response";i.emit("error",new Ht(r)),a(r)}}).catch(function(e){i.emit("error",e),a(e)})}},{key:"signal",value:function(e){var t=this;this._send([e]).catch(function(e){return t.emit("error",e)})}}])&&xt(e.prototype,t),n&&xt(e,n),c}();function Vt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}jt.LOGGER=m.getLogger("PlatformHttpTransmitter"),kt()(jt.prototype);var qt=function(){function s(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),!(this.client=e)&&s.legecyClientSupport&&(s.LOGGER.warn("Legecy support used."),this.client=s.legecyClientSupport)}var e,t,n;return e=s,(t=[{key:"create",value:function(e,t){v("connect(url, config)"),y(e,"url"),s.LOGGER.debug("Creating client context",e,t);var n=new jt(e,t,this.client);n.on("error",function(e){u.emit("error",e)});var r=it.withTransmitter(n).withSlackMS(4).withMaxBatchSize(Number.MAX_SAFE_INTEGER).build(),o=new mt(r),a=new ht(o),i=new dt(e,r,o,t),l=new Rt(r,o,i),u=new Pt(r,a,l,i);return s.LOGGER.debug("clientContext created with",u),u}}])&&Vt(e.prototype,t),n&&Vt(e,n),s}();qt.LOGGER=m.getLogger("ClientContextFactory"),qt.legecyClientSupport=!1;function Ft(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Qt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"createDirectConnection",value:function(e,t){v("createDirectConnection"),y(e,"authEndpoint"),y(t,"realmName");var n=new XMLHttpRequest;return n.open(T.METHOD.POST,e+"/auth/realms/"+t+"/protocol/openid-connect/token",!0),n.setRequestHeader(T.HEADER_NAME.CONTENT_TYPE,T.CONTENT_TYPE.APPLICATION_X_WWW_FORM_URLENCODED),n.responseType=R,n}},{key:"createServerProxyConnection",value:function(e,t){v("createServerProxyConnection"),y(e,"authEndpoint");var n=new XMLHttpRequest;return n.open(T.METHOD.POST,e,!0),n.setRequestHeader(T.HEADER_NAME.CONTENT_TYPE,T.CONTENT_TYPE.TEXT_PLAIN),p(t)&&n.setRequestHeader(T.HEADER_NAME.X_PLATFORM_SECURITY_REALM,t),n.responseType=R,n}}])&&Ft(t.prototype,n),r&&Ft(t,r),e}();function Xt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Yt=function(){function o(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.connection=new Qt}var e,t,n;return e=o,(t=[{key:"createLoginConnection",value:function(e,t,n,r,o,a){var i,l,u=encodeURIComponent(o),s=encodeURIComponent(a),c=encodeURIComponent(r);if(e){if(!p(r))throw Error("No app name set!");i=this.connection.createDirectConnection(t,n),l="client_id="+c+"&username="+u+"&password="+s+"&grant_type=password"}else i=this.connection.createServerProxyConnection(t,n),l="username="+u+"&password="+s+"&grant_type=password";return{connection:i,content:l}}},{key:"createRefreshConnection",value:function(e,t,n,r,o){var a,i,l=encodeURIComponent(r);if(e){if(!p(r))throw Error("No app name set!");a=this.connection.createDirectConnection(t,n),i="grant_type=refresh_token&refresh_token="+o+"&client_id="+l}else a=this.connection.createServerProxyConnection(t,n),i="grant_type=refresh_token&refresh_token="+o;return{connection:a,content:i}}},{key:"receiveToken",value:function(n,r){return new Promise(function(e,t){n.ontimeout=function(e){t(e)},n.onerror=function(e){t(e)},n.onreadystatechange=function(){this.readyState===T.XMLHTTPREQUEST_READYSTATE.DONE&&this.status===T.STATUS.OK?e(this.response):this.readyState===T.XMLHTTPREQUEST_READYSTATE.DONE&&this.status!==T.STATUS.OK&&t(this.status)},o.LOGGER.trace("Receiving token"),n.send(r)})}},{key:"refreshToken",value:function(e,t,n,r,o){var a=this.createRefreshConnection(e,t,n,r,o),i=a.connection,l=a.content;return this.receiveToken(i,l)}}])&&Xt(e.prototype,t),n&&Xt(e,n),o}();function Wt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Yt.LOGGER=m.getLogger("KeycloakFunctions");var Kt=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.token=null,this.appName=null,this.realm=null}var e,n,r;return e=t,(n=[{key:"setToken",value:function(e){this.token=e}},{key:"setAppName",value:function(e){this.appName=e}},{key:"setRealm",value:function(e){this.realm=e}},{key:"handleRequest",value:function(e){v("handleRequest"),y(e,"httpRequest"),p(this.token)&&(t.LOGGER.trace("Using token",this.token),e.setRequestHeader(T.HEADER_NAME.AUTHORIZATION,"Bearer "+this.token)),p(this.appName)&&(t.LOGGER.trace("Using appName",this.appName),e.setRequestHeader(T.HEADER_NAME.X_PLATFORM_SECURITY_APPLICATION,this.appName)),p(this.realm)&&(t.LOGGER.trace("Using realm",this.realm),e.setRequestHeader(T.HEADER_NAME.X_PLATFORM_SECURITY_REALM,this.realm)),e.setRequestHeader(T.HEADER_NAME.X_PLATFORM_SECURITY_BEARER_ONLY,"true")}}])&&Wt(e.prototype,n),r&&Wt(e,r),t}();function zt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Kt.LOGGER=m.getLogger("SecurityHttpClientInterceptor");var Zt=function(){function h(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),this.functions=new Yt,this.interceptor=new Kt,this.intervall=null,this.configuration={directConnection:!1,authEndpoint:k,appName:null,realmName:null}}var e,t,n;return e=h,(t=[{key:"login",value:function(e,t,n){var a=this;if(this.isAuthorized())throw new Error("Already logged in!");n&&(this.configuration.directConnection=n.directConnection||this.configuration.directConnection,this.configuration.authEndpoint=n.authEndpoint||this.configuration.authEndpoint,this.configuration.appName=n.appName||this.configuration.appName,this.configuration.realmName=n.realmName||this.configuration.realmName);var r=this.configuration,i=r.directConnection,l=r.authEndpoint,u=r.appName,s=r.realmName,o=this.functions.createLoginConnection(i,l,s,u,e,t),c=o.connection,d=o.content,f=this;return new Promise(function(r,o){h.LOGGER.debug("Receiving access token"),a.functions.receiveToken(c,d).then(function(e){if(e&&e.access_token){f.token=e,a.interceptor.setToken(e.access_token),a.interceptor.setRealm(s),a.interceptor.setAppName(u);var t=e.expires_in||h.MIN_TOKEN_EXPIRES_RUN,n=Math.max(h.MIN_TOKEN_EXPIRES_RUN,t-h.TOKEN_EXPIRES_DELTA);f.intervall=setInterval(function(){h.LOGGER.debug("Refreshing access token"),f.functions.refreshToken(i,l,s,u,e.refresh_token).then(function(e){f.token=e,f.interceptor.setToken(e.access_token)})},n),r(e.access_token)}else o("No access token found")}).catch(function(e){return o(e)})})}},{key:"logout",value:function(){var t=this,n=this;return h.LOGGER.debug("Logout"),new Promise(function(e){delete n.token,n.interceptor.setToken(null),p(t.intervall)&&(clearInterval(t.intervall),t.intervall=null),e()})}},{key:"isAuthorized",value:function(){return p(this.token)}},{key:"initServiceProvider",value:function(e){v("initServiceProvider"),y(e,"client"),e.getService("HttpClientInterceptor").addRequestInterceptor(this.interceptor)}}])&&zt(e.prototype,t),n&&zt(e,n),h}();function Jt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Zt.TOKEN_EXPIRES_DELTA=1e4,Zt.MIN_TOKEN_EXPIRES_RUN=3e4,Zt.LOGGER=m.getLogger("KeycloakSecurity"),n.d(t,"getService",function(){return $t}),n.d(t,"hasService",function(){return en}),n.d(t,"registerServiceProvider",function(){return tn}),n.d(t,"LoggerFactory",function(){return m}),n.d(t,"LogLevel",function(){return d}),n.d(t,"HTTP",function(){return T}),function(e){if(p(e)){var t=new b(B,"HttpClient",e),n=new b(U,"HttpClientInterceptor",e);e.registerServiceProvider(t),e.registerServiceProvider(n)}}(g),function(e){if(p(e)){var t=new b(j,"ClientScope");e.registerServiceProvider(t)}}(g),function(e){if(p(e)){var t=new b(qt,"ClientContextFactory",e);e.registerServiceProvider(t)}}(g),function(e){if(p(e)){var t=new b(Zt,"Security",e);e.registerServiceProvider(t)}}(g),g.init();var $t=g.getService,en=g.hasService,tn=g.registerServiceProvider;if(g.LOGGER.info("Rico Version:","1.0.1"),window.Worker&&window.Blob&&window.URL&&URL.createObjectURL){g.LOGGER.debug("Creating Worker");var nn=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.blob=new Blob(["self.handleTimeout = function() {    const message = this.statusText || 'Timeout occurred';    const workerMessage = {error: true, message, status: this.status, timedout: true};    self.postMessage(workerMessage);};self.handleError = function () {    let message = this.statusText || 'Unspecified error occured';    const workerMessage = {error: true, message, status: this.status, timedout: false};    self.postMessage(workerMessage);};self.handleStateChange = function () {    if (this.readyState === 4 && this.status >= 200 && this.status < 300) {        const workerMessage = {error: false, response: this.response, status: this.status, url: this.url, responseHeaders: this.getAllResponseHeaders()};        self.postMessage(workerMessage);    } else if (this.readyState === 4 && this.status >= 300) {        const workerMessage = {error: true, message: this.statusText, status: this.status, timedout: false};        self.postMessage(workerMessage);    }};self.addEventListener('message', function(event) {    const timeout = event.data.timeout || 0;    const configuration = event.data.conf || {};    const requestHeaders = event.data.requestHeaders || [];        const httpRequest = new XMLHttpRequest();    const async = true;        httpRequest.open(configuration.method, configuration.url, async);    httpRequest.url = configuration.url;    httpRequest.method = configuration.method;    httpRequest.withCredentials = true;    for (let i = 0; i < requestHeaders.length; i++) {        const header = requestHeaders[i];        httpRequest.setRequestHeader(header.name, header.value);    }    if (configuration.headers && configuration.headers.length > 0) {        for (let i = 0; i < configuration.headers.length; i++) {            const header = configuration.headers[i];            httpRequest.setRequestHeader(header.name, header.value);        }    }    httpRequest.timeout = timeout;    if (configuration.responseType) {        httpRequest.responseType = configuration.responseType;    }    httpRequest.ontimeout = self.handleTimeout.bind(httpRequest);    httpRequest.onerror = self.handleError.bind(httpRequest);    httpRequest.onreadystatechange = self.handleStateChange.bind(httpRequest);    httpRequest.send(configuration.requestBody);});"],{type:"application/javascript"})}var t,n,r;return t=e,(n=[{key:"createWorker",value:function(){return new Worker(URL.createObjectURL(this.blob))}}])&&Jt(t.prototype,n),r&&Jt(t,r),e}(),rn=new b(nn,"HttpWorker");g.registerServiceProvider(rn)}var on=m.getLogger("Deprecated:"),an=!0;function ln(){an&&(on.warn('Please do not use "dolphin" anymore, it may be removed in the next version! Use the new API instead!'),an=!1)}window&&(window.dolphin={get ClientContextFactory(){return ln(),qt.legecyClientSupport=g,qt},get createClientContext(){return ln(),new qt(g).create},get LoggerFactory(){return ln(),m},get LogLevel(){return ln(),d}})}])});
//# sourceMappingURL=rico.min.js.map