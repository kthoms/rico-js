/*!
 * Copyright 2018 Karakun AG.
 * Copyright 2015-2018 Canoo Engineering AG.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ricojs=t():e.ricojs=t()}(window,function(){return r={},o.m=n=[function(e,t){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}(e.exports=n).prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},n.prototype.once=function(e,t){var n=this;function r(){n.off(e,r),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=t,this.on(e,r),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var o=0;o<r.length;o++)if((n=r[o])===t||n.fn===t){r.splice(o,1);break}return this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var r=0,o=(n=n.slice(0)).length;r<o;++r)n[r].apply(this,t);return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length}},function(e,t,n){"use strict";n.r(t),n.d(t,"LoggerFactory",function(){return T}),n.d(t,"LogLevel",function(){return c}),n.d(t,"getService",function(){return Yo}),n.d(t,"hasService",function(){return Wo}),n.d(t,"registerServiceProvider",function(){return Ko}),n.d(t,"HTTP",function(){return D});var r,c={NONE:{name:"NONE",text:"[NONE ]",level:0},ALL:{name:"ALL",text:"[ALL  ]",level:100},TRACE:{name:"TRACE",text:"[TRACE]",level:5},DEBUG:{name:"DEBUG",text:"[DEBUG]",level:4},INFO:{name:"INFO",text:"[INFO ]",level:3},WARN:{name:"WARN",text:"[WARN ]",level:2},ERROR:{name:"ERROR",text:"[ERROR]",level:1}};function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,o=!1,a=void 0;try{for(var i,l=e[Symbol.iterator]();!(r=(i=l.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}return n}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function f(e){return null!=e}function h(e){r=e}function p(e,t){if(!f(e))throw new Error("The parameter "+t+" is mandatory in "+r)}function a(e){var t,n=e.match(/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/);n[4]&&1<n[4].length&&(t=n[4].substring(0,n[4].length-1));var r,o,a=n[13];n[16]&&1<n[16].length&&(r=(r=n[16].substring(1,n[16].length)).split("&").reduce(function(e,t){var n,r,o,a=s(t.split("="),2),i=a[0],l=a[1];return Object.assign(e,(o=l,(r=i)in(n={})?Object.defineProperty(n,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[r]=o,n))},{}));n[17]&&1<n[17].length&&(o=n[17].substring(1,n[17].length));var i=n[11],l=n[12];return i&&!l&&"http"===t?l=80:i&&!l&&"https"===t&&(l=443),i||l||t||(window&&window.location&&window.location.hostname&&(i=window.location.hostname),window&&window.location&&window.location.port&&(l=window.location.port),window&&window.location&&window.location.protocol&&(t=window.location.protocol.substring(0,window.location.protocol.length-1)),0===a.indexOf(".")&&(a=a.substring(1,a.length))),l=l&&parseInt(l),{scheme:t,user:n[8],password:n[9],hostname:i,port:l,path:a,query:r,fragment:o}}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var d,v,y={pad:function(e,t){for(var n=""+e;n.length<t;)n="0"+n;return n},internalLog:function(){var e=Array.from(arguments),t=e.shift(),n=e.shift(),r=e.shift(),o=new Date,a=o.getFullYear()+"-"+y.pad(o.getMonth()+1,2)+"-"+y.pad(o.getDate(),2)+" "+y.pad(o.getHours(),2)+":"+y.pad(o.getMinutes(),2)+":"+y.pad(o.getSeconds(),2)+"."+y.pad(o.getMilliseconds(),3);t.apply(void 0,[a,r.text,n].concat(l(e)))},getCookie:function(e){if(f(window)&&f(window.document)&&f(window.document.cookie)){var t=("; "+window.document.cookie).split("; "+e+"=");if(2===t.length)return t.pop().split(";").shift()}}},m=(i((d=g).prototype,[{key:"trace",value:function(){f(console)&&this.isLogLevel(c.TRACE)&&y.internalLog.apply(y,[console.log,this.context,c.TRACE].concat(Array.prototype.slice.call(arguments)))}},{key:"debug",value:function(){f(console)&&this.isLogLevel(c.DEBUG)&&y.internalLog.apply(y,[console.log,this.context,c.DEBUG].concat(Array.prototype.slice.call(arguments)))}},{key:"info",value:function(){f(console)&&this.isLogLevel(c.INFO)&&y.internalLog.apply(y,[console.log,this.context,c.INFO].concat(Array.prototype.slice.call(arguments)))}},{key:"warn",value:function(){f(console)&&this.isLogLevel(c.WARN)&&y.internalLog.apply(y,[console.warn,this.context,c.WARN].concat(Array.prototype.slice.call(arguments)))}},{key:"error",value:function(){f(console)&&this.isLogLevel(c.ERROR)&&y.internalLog.apply(y,[console.error,this.context,c.ERROR].concat(Array.prototype.slice.call(arguments)))}},{key:"getLogLevel",value:function(){return f(this.logLevel)?this.logLevel:f(this.rootLogger)?this.rootLogger.getLogLevel():c.INFO}},{key:"setLogLevel",value:function(e){this.logLevel=e}},{key:"setLogLevelByName",value:function(e){f(c[e])&&(this.logLevel=c[e])}},{key:"isLogLevel",value:function(e){return this.getLogLevel()!==c.NONE&&(this.getLogLevel()===c.ALL||this.getLogLevel()===c.TRACE||this.getLogLevel()===c.DEBUG&&e!==c.TRACE||this.getLogLevel()===c.INFO&&e!==c.TRACE&&e!==c.DEBUG||this.getLogLevel()===c.WARN&&e!==c.TRACE&&e!==c.DEBUG&&e!==c.INFO||this.getLogLevel()===c.ERROR&&e!==c.TRACE&&e!==c.DEBUG&&e!==c.INFO&&e!==c.WARN)}},{key:"isLogLevelUseable",value:function(e){return p(e,"level"),!!e.level&&this.getLogLevel().level>=e.level}}]),v&&i(d,v),g);function g(e,t){switch(!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,g),this.context=e,this.rootLogger=t,y.getCookie("RICO_LOGGER_"+this.context)){case"NONE":this.logLevel=c.NONE;break;case"ALL":this.logLevel=c.ALL;break;case"TRACE":this.logLevel=c.TRACE;break;case"DEBUG":this.logLevel=c.DEBUG;break;case"INFO":this.logLevel=c.INFO;break;case"WARN":this.logLevel=c.WARN;break;case"ERROR":this.logLevel=c.ERROR}}function C(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var b,E,w=new m("ROOT"),R={loggers:new Map},T=(b=k,(E=[{key:"getLogger",value:function(e){if(!f(e)||"ROOT"===e)return w;var t=R.loggers.get(e);if(t)return t;var n=new m(e,w);return R.loggers.set(e,n),n}}])&&C(b,E),k);function k(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,k)}function A(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,A)}function P(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}A.LOGGER=T.getLogger("Client"),A.services=new Map,A.serviceProviders=new Map,A.configuration={},A.getService=function(e){var t=A.services.get(e);if(!f(t)){var n=A.serviceProviders.get(e);if(!f(n))throw new Error("No service provider found for "+e);t=n.getService(A.configuration),A.services.set(e,t)}return t},A.hasService=function(e){return!!f(A.serviceProviders.get(e))},A.getAllServiceTypes=function(){var t=[];return A.serviceProviders.forEach(function(e){return t.push(e)}),t},A.registerServiceProvider=function(e){if(null==e)throw new Error("Cannot register empty service provider");if("function"!=typeof e.getName||"function"!=typeof e.getService)throw new Error("Cannot register service provider without getName() and getService() methods");if(A.serviceProviders.get(e.getName()))throw new Error("Cannot register another service provider. Name already in use.");A.serviceProviders.set(e.getName(),e),A.LOGGER.debug("Service provider registered with name",e.getName())},A.init=function(){A.serviceProviders.forEach(function(e){var t=e.getService();A.LOGGER.trace("Initializing service for service provider",e.getName()),"function"==typeof t.initServiceProvider&&(A.LOGGER.debug("Initializing service",t),t.initServiceProvider(A))})};var O,M,_=(P((O=I).prototype,[{key:"getName",value:function(){return this.name}},{key:"getService",value:function(){return this.serviceInstance}}]),M&&P(O,M),I);function I(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,I),h("constructor"),p(e,"serviceClass"),p(t,"name"),this.serviceInstance=new e(n),this.name=t}var S="arraybuffer",N="text",L="json",D={METHOD:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},STATUS:{ACCEPTED:202,BAD_GATEWAY:502,BAD_REQUEST:400,CONFLICT:409,CONTINUE:100,CREATED:201,EXPECTATION_FAILED:417,FAILED_DEPENDENCY:424,FORBIDDEN:403,GATEWAY_TIMEOUT:504,GONE:410,HTTP_VERSION_NOT_SUPPORTED:505,IM_A_TEAPOT:418,INSUFFICIENT_SPACE_ON_RESOURCE:419,INSUFFICIENT_STORAGE:507,INTERNAL_SERVER_ERROR:500,LENGTH_REQUIRED:411,LOCKED:423,METHOD_FAILURE:420,METHOD_NOT_ALLOWED:405,MOVED_PERMANENTLY:301,MOVED_TEMPORARILY:302,MULTI_STATUS:207,MULTIPLE_CHOICES:300,NETWORK_AUTHENTICATION_REQUIRED:511,NO_CONTENT:204,NON_AUTHORITATIVE_INFORMATION:203,NOT_ACCEPTABLE:406,NOT_FOUND:404,NOT_IMPLEMENTED:501,NOT_MODIFIED:304,OK:200,PARTIAL_CONTENT:206,PAYMENT_REQUIRED:402,PERMANENT_REDIRECT:308,PRECONDITION_FAILED:412,PRECONDITION_REQUIRED:428,PROCESSING:102,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_HEADER_FIELDS_TOO_LARGE:431,REQUEST_TIMEOUT:408,REQUEST_TOO_LONG:413,REQUEST_URI_TOO_LONG:414,REQUESTED_RANGE_NOT_SATISFIABLE:416,RESET_CONTENT:205,SEE_OTHER:303,SERVICE_UNAVAILABLE:503,SWITCHING_PROTOCOLS:101,TEMPORARY_REDIRECT:307,TOO_MANY_REQUESTS:429,UNAUTHORIZED:401,UNPROCESSABLE_ENTITY:422,UNSUPPORTED_MEDIA_TYPE:415,USE_PROXY:305},HEADER_NAME:{ACCEPT:"Accept",ACCEPT_CHARSET:"Accept-Charset",ACCEPT_ENCODING:"Accept-Encoding",ACCEPT_LANGUAGE:"Accept-Language",ACCEPT_DATETIME:"Accept-Datetime",AUTHORIZATION:"Authorization",CACHE_CONTROL:"Cache-Control",CONNECTION:"Connection",COOKIE:"Cookie",CONTENT_LENGTH:"Content-Length",CONTENT_MD5:"Content-MD5",CONTENT_TYPE:"Content-Type",DATE:"Date",EXPECT:"Expect",FORWARDED:"Forwarded",FROM:"From",HOST:"Host",IF_MATCH:"If-Match",IF_MODIFIED_SINCE:"If-Modified_Since",IF_NONE_MATCH:"If-None_Match",IF_RANGE:"If-Range",MAX_FORWARDS:"Max-Forwards",PRAGMA:"Pragma",PROXY_AUTHORIZATION:"Proxy-Authorization",REFERER:"Referer",TE:"TE",USER_AGENT:"User-Agent",X_CLIENT_ID:"X-Client-Id",X_CLIENT_SESSION_ID:"X-Client-Session-Id",X_PLATFORM_SECURITY_REALM:"X-platform-security-realm",X_PLATFORM_SECURITY_BEARER_ONLY:"X-platform-security-bearer-only",X_PLATFORM_SECURITY_APPLICATION:"X-platform-security-application"},CONTENT_TYPE:{APPLICATION_JSON:"application/json",APPLICATION_X_WWW_FORM_URLENCODED:"application/x-www-form-urlencoded",TEXT_HTML:"text/html",TEXT_PLAIN:"text/plain"},XMLHTTPREQUEST_READYSTATE:{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4}},H="/openid-connect";function B(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var G,U,x=(B((G=j).prototype,[{key:"getUrl",value:function(){return this.url}},{key:"getContent",value:function(){return this.content}},{key:"getStatus",value:function(){return this.status}},{key:"getHeaders",value:function(){return this.headers}},{key:"getHeaderByName",value:function(e){return h("getHeaderByName"),p(e,"name"),this.headers[e.toLowerCase()]}}]),U&&B(G,U),j);function j(e,t,n,r){if(!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,j),this.url=e,this.status=t,this.content=n,this.headers={},f(r)&&"string"==typeof r)for(var o=r.trim().split(/[\r\n]+/),a=0;a<o.length;a++){var i=o[a].split(": ");if(2===i.length){var l=i.shift().toLowerCase(),s=i.join(": ");this.headers[l]=s}}}function V(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var q,F,Q=(V((q=X).prototype,[{key:"getMessage",value:function(){return this.message}},{key:"getStatus",value:function(){return this.status}},{key:"isTimedout",value:function(){return this.timedout}}]),F&&V(q,F),X);function X(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,X),this.message=e,this.status=t||0,this.timedout=n||!1}function Y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var W,K,z,Z=(K=[{key:"execute",value:function(e,t){var s=this,n=null;this.client&&this.client.hasService("HttpWorker")&&(n=this.client.getService("HttpWorker"));var r=null!==n&&(!0===t||!0===e),u=0;!0!==e&&!1!==e&&(u=e);var c=[];this.client&&(c=this.client.getService("HttpClientInterceptor").getRequestInterceptors(),J.LOGGER.trace("Request interceptors found:",c));var d=[];this.client&&(d=this.client.getService("HttpClientInterceptor").getResponseInterceptors(),J.LOGGER.trace("Response interceptors found:",d));var o=function(r,o){var a=s,e=new XMLHttpRequest;e.open(s.configuration.method,s.configuration.url,!0),e.url=s.configuration.url,e.method=s.configuration.method,e.withCredentials=!0;for(var t=0;t<c.length;t++)c[t].handleRequest(e);if(s.configuration.headers&&0<s.configuration.headers.length)for(var n=0;n<s.configuration.headers.length;n++){var i=s.configuration.headers[n];e.setRequestHeader(i.name,i.value)}e.timeout=u,s.configuration.responseType&&(e.responseType=s.configuration.responseType),e.ontimeout=function(){var e=this.statusText||"Timeout occurred",t=new Q(e,this.status,!0);J.LOGGER.error(t),o(t)},e.onerror=function(){var e=this.statusText||"Unspecified error occured",t=new Q(e,this.status);J.LOGGER.error(t),o(t)},e.onreadystatechange=function(){if(this.readyState===D.XMLHTTPREQUEST_READYSTATE.DONE&&J.LOGGER.trace("Request to ",a.configuration.url,"finished with",this.status),this.readyState===D.XMLHTTPREQUEST_READYSTATE.DONE&&200<=this.status&&this.status<300){for(var e=new x(this.url,this.status,this.response,this.getAllResponseHeaders()),t=0;t<d.length;t++)d[t].handleResponse(e);r(e)}else if(this.readyState===D.XMLHTTPREQUEST_READYSTATE.DONE&&300<=this.status){var n=new Q(this.statusText,this.status);J.LOGGER.error(n),o(n)}},e.send(s.configuration.requestBody)};o=o.bind(this);var a=function(a,i){for(var r=[],e=0;e<c.length;e++)c[e].handleRequest({url:s.configuration.url,setRequestHeader:function(e,t){var n={name:e,value:t};r.push(n)}});var l=n.createWorker();try{l.onmessage=function(e){l.terminate(),J.LOGGER.trace("Message form Worker",e);var t=e.data;if(t.error){var n=new Q(t.message,t.status,t.timedout);J.LOGGER.error(n),i(n)}else{for(var r=new x(t.url,t.status,t.response,t.responseHeaders),o=0;o<d.length;o++)d[o].handleResponse(r);a(r)}},l.onerror=function(e){var t=new Q(e.data,0,!1);i(t)},l.postMessage({conf:s.configuration,timeout:u,requestHeaders:r})}catch(e){var t=new Q(e,0,!1);i(t)}};return a=a.bind(this),new Promise(function(e,t){(r&&s.client&&s.client.hasService("HttpWorker")?a:o)(e,t)})}}],Y((W=J).prototype,K),z&&Y(W,z),J);function J(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,J),this.configuration=e,this.client=t}function $(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Z.LOGGER=T.getLogger("Executor");var ee,te,ne=($((ee=re).prototype,[{key:"readBytes",value:function(){return this.configuration.responseType=S,this.executor}},{key:"readString",value:function(){return this.configuration.responseType=N,this.executor}},{key:"readObject",value:function(){return this.configuration.responseType=L,this.executor}},{key:"withoutResult",value:function(){return this.executor}}]),te&&$(ee,te),re);function re(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,re),this.configuration=e,this.executor=new Z(e,t)}function oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ae,ie,le=(oe((ae=se).prototype,[{key:"withHeader",value:function(e,t){return this.configuration.headers||(this.configuration.headers=[]),this.configuration.headers.push({name:e,value:t}),this}},{key:"withHeadersInfo",value:function(e){if(f(e))for(var t in this.configuration.headers||(this.configuration.headers=[]),e)if(e.hasOwnProperty(t)){var n=e[t];this.configuration.headers.push({name:t,value:n})}return this}},{key:"withContent",value:function(e){return this.configuration.requestBody=e,this.reponseBuilder}},{key:"withoutContent",value:function(){return this.reponseBuilder}}]),ie&&oe(ae,ie),se);function se(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,se),this.configuration=e,this.reponseBuilder=new ne(e,t)}function ue(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ce,de,fe=(ue((ce=he).prototype,[{key:"request",value:function(e,t){var n={url:e,method:t};return this.requestBuilder=new le(n,this.client),this.requestBuilder}},{key:"get",value:function(e){return this.request(e,D.METHOD.GET)}},{key:"post",value:function(e){return this.request(e,D.METHOD.POST)}},{key:"put",value:function(e){return this.request(e,D.METHOD.PUT)}},{key:"delete",value:function(e){return this.request(e,D.METHOD.DELETE)}}]),de&&ue(ce,de),he);function he(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,he),this.client=e}function pe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ve,ye,me=(pe((ve=ge).prototype,[{key:"addRequestInterceptor",value:function(e){this.requestHandlers.add(e)}},{key:"getRequestInterceptors",value:function(){var t=[];return this.requestHandlers.forEach(function(e){return t.push(e)}),t}},{key:"addResponseInterceptor",value:function(e){this.responseHandlers.add(e)}},{key:"getResponseInterceptors",value:function(){var t=[];return this.responseHandlers.forEach(function(e){return t.push(e)}),t}}]),ye&&pe(ve,ye),ge);function ge(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,ge),this.requestHandlers=new Set,this.responseHandlers=new Set}function Ce(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var be,Ee,we,Re=(Ee=[{key:"handleRequest",value:function(e){h("handleRequest"),p(e,"httpRequest");var t=this.getClientId(e.url);f(t)&&(Te.LOGGER.trace("Using ClientId",t),e.setRequestHeader(D.HEADER_NAME.X_CLIENT_SESSION_ID,t))}},{key:"handleResponse",value:function(e){h("handleResponse"),p(e,"httpResponse");var t=this.getClientId(e.url),n=e.getHeaderByName(D.HEADER_NAME.X_CLIENT_SESSION_ID);if(f(t)&&f(n)&&t!==n)throw new Error("Client Id does not match!");!f(t)&&f(n)&&(Te.LOGGER.debug("New ClientId found",n),this.setClientId(e.url,n))}},{key:"initServiceProvider",value:function(e){h("initServiceProvider"),p(e,"client"),e.getService("HttpClientInterceptor").addRequestInterceptor(this),e.getService("HttpClientInterceptor").addResponseInterceptor(this)}},{key:"getClientId",value:function(e){var t=a(e),n=Te.calcKey(t.hostname,t.port);return this.clientIds.get(n)}},{key:"setClientId",value:function(e,t){var n=a(e),r=Te.calcKey(n.hostname,n.port);this.clientIds.set(r,t),Te.LOGGER.trace("Setting ClientId",t,"for",e,"with key",r)}}],Ce((be=Te).prototype,Ee),we&&Ce(be,we),Te);function Te(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Te),this.clientIds=new Map}Re.calcKey=function(e,t){return e+t},Re.LOGGER=T.getLogger("ClientScope");var ke="AttributeMetadataChanged",Ae="CallAction",Pe="ChangeAttributeMetadata",Oe="CreateContext",Me="CreateController",_e="CreatePresentationModel",Ie="DeletePresentationModel",Se="DestroyContext",Ne="DestroyController",Le="InterruptLongPoll",De="PresentationModelDeleted",He="StartLongPoll",Be="ValueChanged",Ge="a_id",Ue="p_id",xe="c_id";function je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ve,qe,Fe=(je((Ve=Qe).prototype,[{key:"batch",value:function(e){for(var t=[],n=0;e[n]&&n<=this.maxBatchSize;){var r=e[n];if(n++,this.folding?r.command.id==Be&&0<t.length&&t[t.length-1].command.id==Be&&r.command.attributeId==t[t.length-1].command.attributeId?t[t.length-1].command.newValue=r.command.newValue:r.command.id==De||t.push(r):t.push(r),r.handler)break}return e.splice(0,n),t}}]),qe&&je(Ve,qe),Qe);function Qe(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:50;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Qe),this.folding=e,this.maxBatchSize=t}var Xe="REMOVED";function Ye(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var We,Ke,ze=(Ye((We=Ze).prototype,[{key:"init",value:function(e,t){h("ValueChangedCommand.init()"),p(e,"attributeId"),this.attributeId=e,this.newValue=t}}]),Ke&&Ye(We,Ke),Ze);function Ze(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Ze),this.id=Be}function Je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var $e,et,tt=(Je(($e=nt).prototype,[{key:"init",value:function(e,t,n){h("AttributeMetadataChangedCommand.init()"),p(e,"attributeId"),p(t,"metadataName"),this.attributeId=e,this.metadataName=t,this.value=n}}]),et&&Je($e,et),nt);function nt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,nt),this.id=ke}function rt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ot,at,it=(rt((ot=lt).prototype,[{key:"init",value:function(e,t,n){h("CreateControllerCommand.init()"),p(e,"controllerid"),p(t,"actionName"),this.controllerid=e,this.actionName=t,this.params=n}}]),at&&rt(ot,at),lt);function lt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,lt),this.id=Ae}function st(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ut,ct,dt=(st((ut=ft).prototype,[{key:"init",value:function(e,t,n){h("ChangeAttributeMetadataCommand.init()"),p(e,"attributeId"),p(t,"metadataName"),this.attributeId=e,this.metadataName=t,this.value=n}}]),ct&&st(ut,ct),ft);function ft(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,ft),this.id=Pe}function ht(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,ht),this.id=Oe}function pt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var vt,yt,mt=(pt((vt=gt).prototype,[{key:"init",value:function(e,t){h("CreateControllerCommand.init()"),p(e,"controllerName"),this.controllerName=e,this.parentControllerId=t}}]),yt&&pt(vt,yt),gt);function gt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,gt),this.id=Me}function Ct(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var bt,Et,wt=(Ct((bt=Rt).prototype,[{key:"init",value:function(e){h("CreatePresentationModelCommand.init()"),p(e,"presentationModel"),this.attributes=[],this.clientSideOnly=!1,this.pmId=e.id,this.pmType=e.presentationModelType;var t=this;e.getAttributes().forEach(function(e){t.attributes.push({propertyName:e.propertyName,id:e.id,value:e.getValue()})})}}]),Et&&Ct(bt,Et),Rt);function Rt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Rt),this.id=_e}function Tt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var kt,At,Pt=(Tt((kt=Ot).prototype,[{key:"init",value:function(e){h("DeletePresentationModelCommand.init()"),p(e,"pmId"),this.pmId=e}}]),At&&Tt(kt,At),Ot);function Ot(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Ot),this.id=Ie}function Mt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Mt),this.id=Se}function _t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var It,St,Nt=(_t((It=Lt).prototype,[{key:"init",value:function(e){h("DestroyControllerCommand.init()"),p(e,"controllerId"),this.controllerId=e}}]),St&&_t(It,St),Lt);function Lt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Lt),this.id=Ne}function Dt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Dt),this.id=Le}function Ht(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Bt,Gt,Ut=(Ht((Bt=xt).prototype,[{key:"init",value:function(e){h("PresentationModelDeletedCommand.init()"),p(e,"pmId"),this.pmId=e}}]),Gt&&Ht(Bt,Gt),xt);function xt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,xt),this.id=De}function jt(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,jt),this.id=He}function Vt(e){return(Vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qt(a){return function(){var e,t,n,r=Wt(a);if(Xt()){var o=Wt(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return t=this,!(n=e)||"object"!==Vt(n)&&"function"!=typeof n?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(t):n}}function Ft(e){var r="function"==typeof Map?new Map:void 0;return(Ft=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return Qt(e,arguments,Wt(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Yt(n,e)})(e)}function Qt(e,t,n){return(Qt=Xt()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&Yt(o,n.prototype),o}).apply(null,arguments)}function Xt(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}function Yt(e,t){return(Yt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Wt(e){return(Wt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Kt=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Yt(e,t)}(n,Ft(Error));var t=qt(n);function n(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.call(this,e)}return n}();function zt(e){return(zt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Zt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Jt,$t,en=(Jt=tn,($t=[{key:"_encodeAttributeMetadataChangedCommand",value:function(e){h("Codec.encodeAttributeMetadataChangedCommand"),p(e,"command"),p(e.attributeId,"command.attributeId"),p(e.metadataName,"command.metadataName");var t={};return t.id=ke,t[Ge]=e.attributeId,t.n=e.metadataName,t.v=e.value,t}},{key:"_decodeAttributeMetadataChangedCommand",value:function(e){h("Codec.decodeAttributeMetadataChangedCommand"),p(e,"jsonCommand"),p(e[Ge],"jsonCommand[ATTRIBUTE_ID]"),p(e.n,"jsonCommand[NAME]");var t=new tt;return t.attributeId=e[Ge],t.metadataName=e.n,t.value=e.v,t}},{key:"_encodeCallActionCommand",value:function(e){h("Codec.encodeCallActionCommand"),p(e,"command"),p(e.controllerid,"command.controllerid"),p(e.actionName,"command.actionName"),p(e.params,"command.params");var t={};return t.id=Ae,t[xe]=e.controllerid,t.n=e.actionName,t.p=e.params.map(function(e){var t={};return t.n=e.name,f(e.value)&&(t.v=e.value),t}),t}},{key:"_decodeCallActionCommand",value:function(e){h("Codec.decodeCallActionCommand"),p(e,"jsonCommand"),p(e[xe],"jsonCommand[CONTROLLER_ID]"),p(e.n,"jsonCommand[NAME]"),p(e.p,"jsonCommand[PARAMS]");var t=new it;return t.controllerid=e[xe],t.actionName=e.n,t.params=e.p.map(function(e){return{name:e.n,value:f(e.v)?e.v:null}}),t}},{key:"_encodeChangeAttributeMetadataCommand",value:function(e){h("Codec.encodeChangeAttributeMetadataCommand"),p(e,"command"),p(e.attributeId,"command.attributeId"),p(e.metadataName,"command.metadataName");var t={};return t.id=Pe,t[Ge]=e.attributeId,t.n=e.metadataName,t.v=e.value,t}},{key:"_decodeChangeAttributeMetadataCommand",value:function(e){h("Codec.decodeChangeAttributeMetadataCommand"),p(e,"jsonCommand"),p(e[Ge],"jsonCommand[ATTRIBUTE_ID]"),p(e.n,"jsonCommand[NAME]");var t=new dt;return t.attributeId=e[Ge],t.metadataName=e.n,t.value=e.v,t}},{key:"_encodeCreateContextCommand",value:function(e){h("Codec.encodeCreateContextCommand"),p(e,"command");var t={};return t.id=Oe,t}},{key:"_decodeCreateContextCommand",value:function(e){return h("Codec.decodeCreateContextCommand"),p(e,"jsonCommand"),new ht}},{key:"_encodeCreateControllerCommand",value:function(e){h("Codec._encodeCreateControllerCommand"),p(e,"command"),p(e.controllerName,"command.controllerName");var t={};return t.id=Me,t.n=e.controllerName,t[xe]=e.parentControllerId,t}},{key:"_decodeCreateControllerCommand",value:function(e){h("Codec._decodeCreateControllerCommand"),p(e,"jsonCommand"),p(e.n,"jsonCommand[NAME]"),p(e[xe],"jsonCommand[CONTROLLER_ID]");var t=new mt;return t.controllerName=e.n,t.parentControllerId=e[xe],t}},{key:"_encodeCreatePresentationModelCommand",value:function(e){h("Codec.encodeCreatePresentationModelCommand"),p(e,"command"),p(e.pmId,"command.pmId"),p(e.pmType,"command.pmType");var t={};return t.id=_e,t[Ue]=e.pmId,t.t=e.pmType,t.a=e.attributes.map(function(e){var t={};return t.n=e.propertyName,t[Ge]=e.id,f(e.value)&&(t.v=e.value),t}),t}},{key:"_decodeCreatePresentationModelCommand",value:function(e){h("Codec.decodeCreatePresentationModelCommand"),p(e,"jsonCommand"),p(e[Ue],"jsonCommand[PM_ID]"),p(e.t,"jsonCommand[PM_TYPE]");var t=new wt;return t.pmId=e[Ue],t.pmType=e.t,t.attributes=e.a.map(function(e){return{propertyName:e.n,id:e[Ge],value:f(e.v)?e.v:null}}),t}},{key:"_encodeDeletePresentationModelCommand",value:function(e){h("Codec._encodeDeletePresentationModelCommand"),p(e,"command"),p(e.pmId,"command.pmId");var t={};return t.id=Ie,t[Ue]=e.pmId,t}},{key:"_decodeDeletePresentationModelCommand",value:function(e){h("Codec._decodeDeletePresentationModelCommand"),p(e,"jsonCommand"),p(e[Ue],"jsonCommand[PM_ID]");var t=new Pt;return t.pmId=e[Ue],t}},{key:"_encodeDestroyContextCommand",value:function(e){h("Codec._encodeDestroyContextCommand"),p(e,"command");var t={};return t.id=Se,t}},{key:"_decodeDestroyContextCommand",value:function(e){return h("Codec._decodeDestroyContextCommand"),p(e,"jsonCommand"),new Mt}},{key:"_encodeDestroyControllerCommand",value:function(e){h("Codec._encodeDestroyControllerCommand"),p(e,"command"),p(e.controllerId,"command.controllerId");var t={};return t.id=Ne,t[xe]=e.controllerId,t}},{key:"_decodeDestroyControllerCommand",value:function(e){h("Codec._decodeDestroyControllerCommand"),p(e,"jsonCommand"),p(e[xe],"jsonCommand[CONTROLLER_ID]");var t=new Nt;return t.controllerId=e[xe],t}},{key:"_encodeInterruptLongPollCommand",value:function(e){h("Codec._encodeInterruptLongPollCommand"),p(e,"command");var t={};return t.id=Le,t}},{key:"_decodeInterruptLongPollCommand",value:function(e){return h("Codec._decodeInterruptLongPollCommand"),p(e,"jsonCommand"),new Dt}},{key:"_encodePresentationModelDeletedCommand",value:function(e){h("Codec._encodePresentationModelDeletedCommand"),p(e,"command"),p(e.pmId,"command.pmId");var t={};return t.id=De,t[Ue]=e.pmId,t}},{key:"_decodePresentationModelDeletedCommand",value:function(e){h("Codec._decodePresentationModelDeletedCommand"),p(e,"jsonCommand"),p(e[Ue],"jsonCommand[PM_ID]");var t=new Ut;return t.pmId=e[Ue],t}},{key:"_encodeStartLongPollCommand",value:function(e){h("Codec._encodeStartLongPollCommand"),p(e,"command");var t={};return t.id=He,t}},{key:"_decodeStartLongPollCommand",value:function(e){return h("Codec._decodeStartLongPollCommand"),p(e,"jsonCommand"),new jt}},{key:"_encodeValueChangedCommand",value:function(e){h("Codec.encodeValueChangedCommand"),p(e,"command"),p(e.attributeId,"command.attributeId");var t={};return t.id=Be,t[Ge]=e.attributeId,f(e.newValue)&&(t.v=e.newValue),t}},{key:"_decodeValueChangedCommand",value:function(e){h("Codec.decodeValueChangedCommand"),p(e,"jsonCommand"),p(e[Ge],"jsonCommand[ATTRIBUTE_ID]");var t=new ze;return t.attributeId=e[Ge],f(e.v)?t.newValue=e.v:t.newValue=null,t}},{key:"encode",value:function(e){h("Codec.encode"),p(e,"commands");var t=this;return JSON.stringify(e.map(function(e){if(e.id===ke)return t._encodeAttributeMetadataChangedCommand(e);if(e.id===Ae)return t._encodeCallActionCommand(e);if(e.id===Pe)return t._encodeChangeAttributeMetadataCommand(e);if(e.id===Oe)return t._encodeCreateContextCommand(e);if(e.id===Me)return t._encodeCreateControllerCommand(e);if(e.id===_e)return t._encodeCreatePresentationModelCommand(e);if(e.id===Ie)return t._encodeDeletePresentationModelCommand(e);if(e.id===Se)return t._encodeDestroyContextCommand(e);if(e.id===Ne)return t._encodeDestroyControllerCommand(e);if(e.id===Le)return t._encodeInterruptLongPollCommand(e);if(e.id===De)return t._encodePresentationModelDeletedCommand(e);if(e.id===He)return t._encodeStartLongPollCommand(e);if(e.id===Be)return t._encodeValueChangedCommand(e);throw new Kt("Command of type "+e.id+" can not be handled")}))}},{key:"decode",value:function(e){if(h("Codec.decode"),p(e,"transmitted"),"string"!==zt(e))throw new Kt("Can not decode data that is not of type string");var t=this;return JSON.parse(e).map(function(e){if(e.id===ke)return t._decodeAttributeMetadataChangedCommand(e);if(e.id===Ae)return t._decodeCallActionCommand(e);if(e.id===Pe)return t._decodeChangeAttributeMetadataCommand(e);if(e.id===Oe)return t._decodeCreateContextCommand(e);if(e.id===Me)return t._decodeCreateControllerCommand(e);if(e.id===_e)return t._decodeCreatePresentationModelCommand(e);if(e.id===Ie)return t._decodeDeletePresentationModelCommand(e);if(e.id===Se)return t._decodeDestroyContextCommand(e);if(e.id===Ne)return t._decodeDestroyControllerCommand(e);if(e.id===Le)return t._decodeInterruptLongPollCommand(e);if(e.id===De)return t._decodePresentationModelDeletedCommand(e);if(e.id===He)return t._decodeStartLongPollCommand(e);if(e.id===Be)return t._decodeValueChangedCommand(e);throw new Kt("Command of type "+e.id+" can not be handled")})}}])&&Zt(Jt,$t),tn);function tn(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,tn)}function nn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var rn,on,an=(nn((rn=ln).prototype,[{key:"onEvent",value:function(e){this.eventHandlers.push(e)}},{key:"trigger",value:function(t){this.eventHandlers.forEach(function(e){return e(t)})}}]),on&&nn(rn,on),ln);function ln(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,ln),this.eventHandlers=[]}function sn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var un,cn,dn,fn=0,hn=(cn=[{key:"copy",value:function(){var n=new pn(null,this.presentationModelType);return n.clientSideOnly=!0,this.getAttributes().forEach(function(e){var t=e.copy();n.addAttribute(t)}),n}},{key:"addAttributes",value:function(e){var t=this;!e||e.length<1||e.forEach(function(e){t.addAttribute(e)})}},{key:"addAttribute",value:function(e){var t=this;if(e&&!(-1<this.attributes.indexOf(e))){if(this.findAttributeByPropertyName(e.propertyName))throw new Error("There already is an attribute with property name: "+e.propertyName+" in presentation model with id: "+this.id);if(e.getQualifier()&&this.findAttributeByQualifier(e.getQualifier()))throw new Error("There already is an attribute with qualifier: "+e.getQualifier()+" in presentation model with id: "+this.id);e.setPresentationModel(this),this.attributes.push(e),e.onValueChange(function(){t.invalidBus.trigger({source:t})})}}},{key:"onInvalidated",value:function(e){this.invalidBus.onEvent(e)}},{key:"getAttributes",value:function(){return this.attributes.slice(0)}},{key:"getAt",value:function(e){return this.findAttributeByPropertyName(e)}},{key:"findAllAttributesByPropertyName",value:function(t){var n=[];return t?(this.attributes.forEach(function(e){e.propertyName==t&&n.push(e)}),n):null}},{key:"findAttributeByPropertyName",value:function(e){if(!e)return null;for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].propertyName==e)return this.attributes[t];return null}},{key:"findAttributeByQualifier",value:function(e){if(!e)return null;for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].getQualifier()==e)return this.attributes[t];return null}},{key:"findAttributeById",value:function(e){if(!e)return null;for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].id==e)return this.attributes[t];return null}},{key:"syncWith",value:function(n){this.attributes.forEach(function(e){var t=n.getAt(e.propertyName);t&&e.syncWith(t)})}}],sn((un=pn).prototype,cn),dn&&sn(un,dn),pn);function pn(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,pn),this.id=e,this.presentationModelType=t,this.attributes=[],this.clientSideOnly=!1,this.dirty=!1,this.id=void 0!==e&&null!=e?e:(fn++).toString(),this.invalidBus=new an,this.dirtyValueChangeBus=new an}function vn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var yn,mn,gn,Cn=(mn=[{key:"setCommandBatcher",value:function(e){this.commandBatcher=e}},{key:"setPushEnabled",value:function(e){this.pushEnabled=e}},{key:"setPushListener",value:function(e){this.pushListener=e}},{key:"setReleaseCommand",value:function(e){this.releaseCommand=e}},{key:"send",value:function(e,t){this.commandQueue.push({command:e,handler:t}),this.currentlySending?this.release():this.doSendNext()}},{key:"doSendNext",value:function(){var r=this;if(this.commandQueue.length<1){if(!this.pushEnabled)return void(this.currentlySending=!1);this.enqueuePushCommand()}this.currentlySending=!0;var e=this.commandBatcher.batch(this.commandQueue);if(0<e.length){var t=e[e.length-1].handler,n=e.map(function(e){return e.command});this.transmitter.transmit(n,function(e){var n=[];e.forEach(function(e){var t=r.handle(e);t&&n.push(t)}),t&&t.onFinished(n),setTimeout(function(){return r.doSendNext()},r.slackMS)},function(e){t.onError(e)})}else setTimeout(function(){return r.doSendNext()},this.slackMS)}},{key:"handle",value:function(e){return"DeletePresentationModel"===e.id?this.handleDeletePresentationModelCommand(e):"CreatePresentationModel"===e.id?this.handleCreatePresentationModelCommand(e):"ValueChanged"===e.id?this.handleValueChangedCommand(e):"AttributeMetadataChanged"===e.id?this.handleAttributeMetadataChangedCommand(e):(bn.LOGGER.error("Cannot handle, unknown command "+e),null)}},{key:"handleDeletePresentationModelCommand",value:function(e){var t=this.clientDolphin.findPresentationModelById(e.pmId);return t?(this.clientDolphin.getClientModelStore().deletePresentationModel(t,!0),t):null}},{key:"handleCreatePresentationModelCommand",value:function(e){var n=this;if(this.clientDolphin.getClientModelStore().containsPresentationModel(e.pmId))throw new Error("There already is a presentation model with id "+e.pmId+"  known to the client.");var r=[];e.attributes.forEach(function(e){var t=n.clientDolphin.attribute(e.propertyName,e.qualifier,e.value);e.id&&e.id.match(".*S$")&&(t.id=e.id),r.push(t)});var t=new hn(e.pmId,e.pmType);return t.addAttributes(r),e.clientSideOnly&&(t.clientSideOnly=!0),this.clientDolphin.getClientModelStore().add(t,!1),this.clientDolphin.updatePresentationModelQualifier(t),t}},{key:"handleValueChangedCommand",value:function(e){var t=this.clientDolphin.getClientModelStore().findAttributeById(e.attributeId);return t?t.getValue()===e.newValue||t.setValueFromServer(e.newValue):bn.LOGGER.error("attribute with id "+e.attributeId+" not found, cannot update to new value "+e.newValue),null}},{key:"handleAttributeMetadataChangedCommand",value:function(e){var t=this.clientDolphin.getClientModelStore().findAttributeById(e.attributeId);return t&&(t[e.metadataName]=e.value),null}},{key:"listen",value:function(){this.pushEnabled&&(this.waiting||this.currentlySending||this.doSendNext())}},{key:"enqueuePushCommand",value:function(){var e=this;this.waiting=!0,this.commandQueue.push({command:this.pushListener,handler:{onFinished:function(){e.waiting=!1},onFinishedData:null}})}},{key:"release",value:function(){this.waiting&&(this.waiting=!1,this.transmitter.signal(this.releaseCommand))}}],vn((yn=bn).prototype,mn),gn&&vn(yn,gn),bn);function bn(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:50;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,bn),this.commandQueue=[],this.currentlySending=!1,this.pushEnabled=!1,this.waiting=!1,this.transmitter=e,this.clientDolphin=t,this.slackMS=n,this.codec=new en,this.commandBatcher=new Fe(!0,r)}function En(e){return(En="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function wn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Cn.LOGGER=T.getLogger("ClientConnector");var Rn,Tn,kn,An=(kn=[{key:"checkValue",value:function(e){if(null==e||void 0===e)return null;var t=e;(t instanceof String||t instanceof Boolean||t instanceof Number)&&(t=e.valueOf()),t instanceof Pn&&(Pn.LOGGER.warn("An Attribute may not itself contain an attribute as a value. Assuming you forgot to call value."),t=this.checkValue(e.value));var n=!1;if((-1<this.SUPPORTED_VALUE_TYPES.indexOf(En(t))||t instanceof Date)&&(n=!0),!n)throw new Error("Attribute values of this type are not allowed: "+En(e));return t}}],Tn=[{key:"copy",value:function(){return new Pn(this.propertyName,this.getQualifier(),this.getValue())}},{key:"setPresentationModel",value:function(e){if(this.presentationModel)throw new Error("You can not set a presentation model for an attribute that is already bound.");this.presentationModel=e}},{key:"getPresentationModel",value:function(){return this.presentationModel}},{key:"getValue",value:function(){return this.value}},{key:"setValueFromServer",value:function(e){var t=Pn.checkValue(e);if(this.value!==t){var n=this.value;this.value=t,this.valueChangeBus.trigger({oldValue:n,newValue:t,sendToServer:!1})}}},{key:"setValue",value:function(e){var t=Pn.checkValue(e);if(this.value!==t){var n=this.value;this.value=t,this.valueChangeBus.trigger({oldValue:n,newValue:t,sendToServer:!0})}}},{key:"setQualifier",value:function(e){if(this.qualifier!==e){var t=this.qualifier;this.qualifier=e,this.qualifierChangeBus.trigger({oldValue:t,newValue:e}),this.valueChangeBus.trigger({oldValue:this.value,newValue:this.value,sendToServer:!1})}}},{key:"getQualifier",value:function(){return this.qualifier}},{key:"onValueChange",value:function(e){this.valueChangeBus.onEvent(e),e({oldValue:this.value,newValue:this.value,sendToServer:!1})}},{key:"onQualifierChange",value:function(e){this.qualifierChangeBus.onEvent(e)}},{key:"syncWith",value:function(e){e&&(this.setQualifier(e.getQualifier()),this.setValue(e.value))}}],wn((Rn=Pn).prototype,Tn),kn&&wn(Rn,kn),Pn);function Pn(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Pn),this.propertyName=e,this.id=Pn.clientAttributeInstanceCount+++"C",this.valueChangeBus=new an,this.qualifierChangeBus=new an,this.setValue(n),this.setQualifier(t)}function On(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}An.LOGGER=T.getLogger("ClientAttribute"),An.SUPPORTED_VALUE_TYPES=["string","number","boolean"],An.clientAttributeInstanceCount=0;var Mn,_n,In=(On((Mn=Sn).prototype,[{key:"setClientConnector",value:function(e){this.clientConnector=e}},{key:"getClientConnector",value:function(){return this.clientConnector}},{key:"send",value:function(e,t){this.clientConnector.send(e,t)}},{key:"attribute",value:function(e,t,n){return new An(e,t,n)}},{key:"presentationModel",value:function(e,t){for(var n=new hn(e,t),r=arguments.length,o=new Array(2<r?r-2:0),a=2;a<r;a++)o[a-2]=arguments[a];return o&&0<o.length&&o.forEach(function(e){n.addAttribute(e)}),this.getClientModelStore().add(n,!0),n}},{key:"setClientModelStore",value:function(e){this.clientModelStore=e}},{key:"getClientModelStore",value:function(){return this.clientModelStore}},{key:"listPresentationModelIds",value:function(){return this.getClientModelStore().listPresentationModelIds()}},{key:"listPresentationModels",value:function(){return this.getClientModelStore().listPresentationModels()}},{key:"findAllPresentationModelByType",value:function(e){return this.getClientModelStore().findAllPresentationModelByType(e)}},{key:"getAt",value:function(e){return this.findPresentationModelById(e)}},{key:"findPresentationModelById",value:function(e){return this.getClientModelStore().findPresentationModelById(e)}},{key:"deletePresentationModel",value:function(e){this.getClientModelStore().deletePresentationModel(e,!0)}},{key:"updatePresentationModelQualifier",value:function(e){var t=this;e.getAttributes().forEach(function(e){t.updateAttributeQualifier(e)})}},{key:"updateAttributeQualifier",value:function(t){t.getQualifier()&&this.getClientModelStore().findAllAttributesByQualifier(t.getQualifier()).forEach(function(e){e.setValue(t.getValue())})}},{key:"startPushListening",value:function(e,t){var n=this;this.clientConnector.setPushListener(e),this.clientConnector.setReleaseCommand(t),this.clientConnector.setPushEnabled(!0),setTimeout(function(){n.clientConnector.listen()},0)}},{key:"stopPushListening",value:function(){this.clientConnector.setPushEnabled(!1)}}]),_n&&On(Mn,_n),Sn);function Sn(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Sn)}function Nn(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Nn)}function Ln(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Nn.QUALIFIER_PROPERTY="qualifier",Nn.VALUE="value";var Dn,Hn,Bn=(Dn=Gn,(Hn=[{key:"createCreateContextCommand",value:function(){return new ht}},{key:"createCreateControllerCommand",value:function(e,t){var n=new mt;return n.init(e,t),n}},{key:"createCallActionCommand",value:function(e,t,n){var r=new it;return r.init(e,t,n),r}},{key:"createDestroyControllerCommand",value:function(e){var t=new Nt;return t.init(e),t}},{key:"createDestroyContextCommand",value:function(){return new Mt}},{key:"createStartLongPollCommand",value:function(){return new jt}},{key:"createInterruptLongPollCommand",value:function(){return new Dt}},{key:"createCreatePresentationModelCommand",value:function(e){var t=new wt;return t.init(e),t}},{key:"createDeletePresentationModelCommand",value:function(e){var t=new Pt;return t.init(e),t}},{key:"createPresentationModelDeletedCommand",value:function(e){var t=new Ut;return t.init(e),t}},{key:"createValueChangedCommand",value:function(e,t){var n=new ze;return n.init(e,t),n}},{key:"createChangeAttributeMetadataCommand",value:function(e,t,n){var r=new dt;return r.init(e,t,n),r}},{key:"createAttributeMetadataChangedCommand",value:function(e,t,n){var r=new tt;return r.init(e,t,n),r}}])&&Ln(Dn,Hn),Gn);function Gn(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Gn)}function Un(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var xn,jn,Vn,qn=(jn=[{key:"getClientDolphin",value:function(){return this.clientDolphin}},{key:"registerAttribute",value:function(n){var r=this;this.addAttributeById(n),n.getQualifier()&&this.addAttributeByQualifier(n),n.onValueChange(function(e){if(e.newValue!==e.oldValue&&!0===e.sendToServer){var t=Bn.createValueChangedCommand(n.id,e.newValue);r.clientDolphin.getClientConnector().send(t,null)}n.getQualifier()&&r.findAttributesByFilter(function(e){return e!==n&&e.getQualifier()===n.getQualifier()}).forEach(function(e){e.setValue(n.getValue())})}),n.onQualifierChange(function(e){r.clientDolphin.getClientConnector().send(Bn.createChangeAttributeMetadataCommand(n.id,Nn.QUALIFIER_PROPERTY,e.newValue),null)})}},{key:"add",value:function(e,t){var n=this,r=!(1<arguments.length&&void 0!==t)||t;if(!e)return!1;this.presentationModels.has(e.id)&&Fn.LOGGER.error("There already is a PM with id "+e.id);var o=!1;return this.presentationModels.has(e.id)||(this.presentationModels.set(e.id,e),this.addPresentationModelByType(e),r&&this.clientDolphin.getClientConnector().send(Bn.createCreatePresentationModelCommand(e),null),e.getAttributes().forEach(function(e){n.registerAttribute(e)}),this.modelStoreChangeBus.trigger({eventType:"ADDED",clientPresentationModel:e}),o=!0),o}},{key:"remove",value:function(e){var t=this;if(!e)return!1;var n=!1;return this.presentationModels.has(e.id)&&(this.removePresentationModelByType(e),this.presentationModels.delete(e.id),e.getAttributes().forEach(function(e){t.removeAttributeById(e),e.getQualifier()&&t.removeAttributeByQualifier(e)}),this.modelStoreChangeBus.trigger({eventType:Xe,clientPresentationModel:e}),n=!0),n}},{key:"findAttributesByFilter",value:function(t){var n=[];return this.presentationModels.forEach(function(e){e.getAttributes().forEach(function(e){t(e)&&n.push(e)})}),n}},{key:"addPresentationModelByType",value:function(e){if(e){var t=e.presentationModelType;if(t){var n=this.presentationModelsPerType.get(t);n||(n=[],this.presentationModelsPerType.set(t,n)),-1<n.indexOf(e)||n.push(e)}}}},{key:"removePresentationModelByType",value:function(e){if(e&&e.presentationModelType){var t=this.presentationModelsPerType.get(e.presentationModelType);t&&(-1<t.length&&t.splice(t.indexOf(e),1),0===t.length&&this.presentationModelsPerType.delete(e.presentationModelType))}}},{key:"listPresentationModelIds",value:function(){for(var e=[],t=this.presentationModels.keys(),n=t.next();!n.done;)e.push(n.value),n=t.next();return e}},{key:"listPresentationModels",value:function(){for(var e=[],t=this.presentationModels.values(),n=t.next();!n.done;)e.push(n.value),n=t.next();return e}},{key:"findPresentationModelById",value:function(e){return this.presentationModels.get(e)}},{key:"findAllPresentationModelByType",value:function(e){return e&&this.presentationModelsPerType.has(e)?this.presentationModelsPerType.get(e).slice(0):[]}},{key:"deletePresentationModel",value:function(e,t){if(e&&this.containsPresentationModel(e.id)){if(this.remove(e),!t||e.clientSideOnly)return;this.clientDolphin.getClientConnector().send(Bn.createPresentationModelDeletedCommand(e.id),null)}}},{key:"containsPresentationModel",value:function(e){return this.presentationModels.has(e)}},{key:"addAttributeById",value:function(e){e&&!this.attributesPerId.has(e.id)&&this.attributesPerId.set(e.id,e)}},{key:"removeAttributeById",value:function(e){e&&this.attributesPerId.has(e.id)&&this.attributesPerId.delete(e.id)}},{key:"findAttributeById",value:function(e){return this.attributesPerId.get(e)}},{key:"addAttributeByQualifier",value:function(e){if(e&&e.getQualifier()){var t=this.attributesPerQualifier.get(e.getQualifier());t||(t=[],this.attributesPerQualifier.set(e.getQualifier(),t)),-1<t.indexOf(e)||t.push(e)}}},{key:"removeAttributeByQualifier",value:function(e){if(e&&e.getQualifier()){var t=this.attributesPerQualifier.get(e.getQualifier());t&&(-1<t.length&&t.splice(t.indexOf(e),1),0===t.length&&this.attributesPerQualifier.delete(e.getQualifier()))}}},{key:"findAllAttributesByQualifier",value:function(e){return e&&this.attributesPerQualifier.has(e)?this.attributesPerQualifier.get(e).slice(0):[]}},{key:"onModelStoreChange",value:function(e){this.modelStoreChangeBus.onEvent(e)}},{key:"onModelStoreChangeForType",value:function(t,n){this.modelStoreChangeBus.onEvent(function(e){e.clientPresentationModel.presentationModelType==t&&n(e)})}}],Un((xn=Fn).prototype,jn),Vn&&Un(xn,Vn),Fn);function Fn(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Fn),this.clientDolphin=e,this.presentationModels=new Map,this.presentationModelsPerType=new Map,this.attributesPerId=new Map,this.attributesPerQualifier=new Map,this.modelStoreChangeBus=new an}function Qn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}qn.LOGGER=T.getLogger("ClientModelStore");var Xn,Yn,Wn=(Qn((Xn=Kn).prototype,[{key:"transmit",value:function(e,t){t([])}},{key:"signal",value:function(){}},{key:"reset",value:function(){}}]),Yn&&Qn(Xn,Yn),Kn);function Kn(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Kn)}function zn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Zn,Jn,$n,er=(Jn=[{key:"withSlackMS",value:function(e){return this.slackMS=e,this}},{key:"withMaxBatchSize",value:function(e){return this.maxBatchSize=e,this}},{key:"withTransmitter",value:function(e){return this.transmitter=e,this}},{key:"build",value:function(){var e,t=new In;return e=this.transmitter?this.transmitter:new Wn,t.setClientConnector(new Cn(e,t,this.slackMS,this.maxBatchSize)),t.setClientModelStore(new qn(t)),tr.LOGGER.debug("Remoting client initialized",t,e),t}}],zn((Zn=tr).prototype,Jn),$n&&zn(Zn,$n),tr);function tr(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,tr),this.slackMS=300,this.maxBatchSize=50,this.transmitter=null}er.LOGGER=T.getLogger("DolphinBuilder");var nr=new er;function rr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var or,ar,ir="@@@ R_BEAN @@@",lr="@@@ CONTROLLER_ACTION_CALL_BEAN @@@",sr="@@@ SOURCE_SYSTEM @@@",ur=(rr((or=cr).prototype,[{key:"connect",value:function(){this.dolphin.startPushListening(Bn.createStartLongPollCommand(),Bn.createInterruptLongPollCommand())}},{key:"onModelAdded",value:function(e){switch(h("Connector.onModelAdded(model)"),p(e,"model"),e.presentationModelType){case lr:break;case ir:this.classRepository.registerClass(e);break;case"@@@ HIGHLANDER_BEAN @@@":this.highlanderPMResolver(e);break;case"@R:LS@":this.classRepository.spliceListEntry(e),this.dolphin.deletePresentationModel(e);break;default:this.classRepository.load(e)}}},{key:"onModelRemoved",value:function(e){switch(h("Connector.onModelRemoved(model)"),p(e,"model"),e.presentationModelType){case ir:this.classRepository.unregisterClass(e);break;case"@R:LS@":break;default:this.classRepository.unload(e)}}},{key:"invoke",value:function(e){h("Connector.invoke(command)"),p(e,"command");var r=this.dolphin;return new Promise(function(t,n){r.send(e,{onFinished:function(e){t(e)},onError:function(e){n(e)}})})}},{key:"getHighlanderPM",value:function(){return this.highlanderPMPromise}}]),ar&&rr(or,ar),cr);function cr(e,t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,cr),h("Connector(url, dolphin, classRepository, config)"),p(e,"url"),p(t,"dolphin"),p(n,"classRepository");var o=this;this.dolphin=t,this.config=r,this.classRepository=n,this.highlanderPMResolver=function(){},this.highlanderPMPromise=new Promise(function(e){o.highlanderPMResolver=e}),t.getClientModelStore().onModelStoreChange(function(e){var t=e.clientPresentationModel,n=t.findAttributeByPropertyName(sr);f(n)&&"server"===n.value&&("ADDED"===e.eventType?o.onModelAdded(t):e.eventType===Xe&&o.onModelRemoved(t))})}function dr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var fr,hr,pr,vr=(hr=[{key:"_handleBeanAdded",value:function(t,n){var e=this.addedHandlers.get(t);f(e)&&e.forEach(function(e){try{e(n)}catch(e){yr.LOGGER.error("An exception occurred while calling an onBeanAdded-handler for type",t,e)}}),this.allAddedHandlers.forEach(function(e){try{e(n)}catch(e){yr.LOGGER.error("An exception occurred while calling a general onBeanAdded-handler",e)}})}},{key:"_handleBeanRemoved",value:function(t,n){var e=this.removedHandlers.get(t);f(e)&&e.forEach(function(e){try{e(n)}catch(e){yr.LOGGER.error("An exception occurred while calling an onBeanRemoved-handler for type",t,e)}}),this.allRemovedHandlers.forEach(function(e){try{e(n)}catch(e){yr.LOGGER.error("An exception occurred while calling a general onBeanRemoved-handler",e)}})}},{key:"_handleArrayUpdate",value:function(t,n,r,o,a,i){var e=this.arrayUpdatedHandlers.get(t);f(e)&&e.forEach(function(e){try{e(n,r,o,a,i)}catch(e){yr.LOGGER.error("An exception occurred while calling an onArrayUpdate-handler for type",t,e)}}),this.allArrayUpdatedHandlers.forEach(function(e){try{e(n,r,o,a,i)}catch(e){yr.LOGGER.error("An exception occurred while calling a general onArrayUpdate-handler",e)}})}},{key:"_handleBeanUpdate",value:function(t,n,r,o,a){var e=this.updatedHandlers.get(t);f(e)&&e.forEach(function(e){try{e(n,r,o,a)}catch(e){yr.LOGGER.error("An exception occurred while calling an onBeanUpdate-handler for type",t,e)}}),this.allUpdatedHandlers.forEach(function(e){try{e(n,r,o,a)}catch(e){yr.LOGGER.error("An exception occurred while calling a general onBeanUpdate-handler",e)}})}},{key:"notifyBeanChange",value:function(e,t,n){return h("BeanManager.notifyBeanChange(bean, propertyName, newValue)"),p(e,"bean"),p(t,"propertyName"),this.classRepository.notifyBeanChange(e,t,n)}},{key:"notifyArrayChange",value:function(e,t,n,r,o){h("BeanManager.notifyArrayChange(bean, propertyName, index, count, removedElements)"),p(e,"bean"),p(t,"propertyName"),p(n,"index"),p(r,"count"),p(o,"removedElements"),this.classRepository.notifyArrayChange(e,t,n,r,o)}},{key:"isManaged",value:function(e){throw h("BeanManager.isManaged(bean)"),p(e,"bean"),new Error("Not implemented yet")}},{key:"create",value:function(e){throw h("BeanManager.create(type)"),p(e,"type"),new Error("Not implemented yet")}},{key:"add",value:function(e,t){throw h("BeanManager.add(type, bean)"),p(e,"type"),p(t,"bean"),new Error("Not implemented yet")}},{key:"addAll",value:function(e,t){throw h("BeanManager.addAll(type, collection)"),p(e,"type"),p(t,"collection"),new Error("Not implemented yet")}},{key:"remove",value:function(e){throw h("BeanManager.remove(bean)"),p(e,"bean"),new Error("Not implemented yet")}},{key:"removeAll",value:function(e){throw h("BeanManager.removeAll(collection)"),p(e,"collection"),new Error("Not implemented yet")}},{key:"removeIf",value:function(e){throw h("BeanManager.removeIf(predicate)"),p(e,"predicate"),new Error("Not implemented yet")}},{key:"onAdded",value:function(t,n){var r=this;if(f(n)){h("BeanManager.onAdded(type, eventHandler)"),p(t,"type"),p(n,"eventHandler");var e=this.addedHandlers.get(t);return f(e)||(e=[]),this.addedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.addedHandlers.get(t);f(e)&&r.addedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return h("BeanManager.onAdded(eventHandler)"),p(n=t,"eventHandler"),this.allAddedHandlers=this.allAddedHandlers.concat(n),{unsubscribe:function(){r.allAddedHandlers=r.allAddedHandlers.filter(function(e){return e!==n})}}}},{key:"onRemoved",value:function(t,n){var r=this;if(f(n)){h("BeanManager.onRemoved(type, eventHandler)"),p(t,"type"),p(n,"eventHandler");var e=this.removedHandlers.get(t);return f(e)||(e=[]),this.removedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.removedHandlers.get(t);f(e)&&r.removedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return h("BeanManager.onRemoved(eventHandler)"),p(n=t,"eventHandler"),this.allRemovedHandlers=this.allRemovedHandlers.concat(n),{unsubscribe:function(){r.allRemovedHandlers=r.allRemovedHandlers.filter(function(e){return e!==n})}}}},{key:"onBeanUpdate",value:function(t,n){var r=this;if(f(n)){h("BeanManager.onBeanUpdate(type, eventHandler)"),p(t,"type"),p(n,"eventHandler");var e=this.updatedHandlers.get(t);return f(e)||(e=[]),this.updatedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.updatedHandlers.get(t);f(e)&&r.updatedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return h("BeanManager.onBeanUpdate(eventHandler)"),p(n=t,"eventHandler"),this.allUpdatedHandlers=this.allUpdatedHandlers.concat(n),{unsubscribe:function(){r.allUpdatedHandlers=r.allUpdatedHandlers.filter(function(e){return e!==n})}}}},{key:"onArrayUpdate",value:function(t,n){var r=this;if(f(n)){h("BeanManager.onArrayUpdate(type, eventHandler)"),p(t,"type"),p(n,"eventHandler");var e=this.arrayUpdatedHandlers.get(t);return f(e)||(e=[]),this.arrayUpdatedHandlers.set(t,e.concat(n)),{unsubscribe:function(){var e=r.arrayUpdatedHandlers.get(t);f(e)&&r.arrayUpdatedHandlers.set(t,e.filter(function(e){return e!==n}))}}}return h("BeanManager.onArrayUpdate(eventHandler)"),p(n=t,"eventHandler"),this.allArrayUpdatedHandlers=this.allArrayUpdatedHandlers.concat(n),{unsubscribe:function(){r.allArrayUpdatedHandlers=r.allArrayUpdatedHandlers.filter(function(e){return e!==n})}}}}],dr((fr=yr).prototype,hr),pr&&dr(fr,pr),yr);function yr(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,yr),h("BeanManager(classRepository)"),p(e,"classRepository"),this.classRepository=e,this.addedHandlers=new Map,this.removedHandlers=new Map,this.updatedHandlers=new Map,this.arrayUpdatedHandlers=new Map,this.allAddedHandlers=[],this.allRemovedHandlers=[],this.allUpdatedHandlers=[],this.allArrayUpdatedHandlers=[],this._handleBeanAdded=this._handleBeanAdded.bind(this),this._handleBeanRemoved=this._handleBeanRemoved.bind(this),this._handleBeanUpdate=this._handleBeanUpdate.bind(this),this._handleArrayUpdate=this._handleArrayUpdate.bind(this),this.classRepository.onBeanAdded(this._handleBeanAdded),this.classRepository.onBeanRemoved(this._handleBeanRemoved),this.classRepository.onBeanUpdate(this._handleBeanUpdate),this.classRepository.onArrayUpdate(this._handleArrayUpdate)}function mr(e){return(mr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function gr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}vr.LOGGER=T.getLogger("BeanManager");var Cr,br,Er,wr=(br=[{key:"sendListSplice",value:function(n,e,t,r,o,a){var i=n.dolphin,l=i.findPresentationModelById(e);if(f(l)){var s=n.classes.get(l.presentationModelType)[t];if(f(s)){var u=[i.attribute("@@@ SOURCE_SYSTEM @@@",null,"client"),i.attribute("source",null,e),i.attribute("attribute",null,t),i.attribute("from",null,r),i.attribute("to",null,o),i.attribute("count",null,a.length)];a.forEach(function(e,t){u.push(i.attribute(t.toString(),null,Rr.toDolphin(n,s,e)))}),i.presentationModel.apply(i,[null,"@DP:LS@"].concat(u))}}}},{key:"validateList",value:function(e,t,n,r){f(n[r])||e.propertyUpdateHandlers.forEach(function(e){try{e(t,n,r,[],void 0)}catch(e){Rr.LOGGER.error("An exception occurred while calling an onBeanUpdate-handler",e)}})}},{key:"block",value:function(e,t){if(f(this.blocked))throw new Error("Trying to create a block while another block exists");this.blocked={bean:e,propertyName:t}}},{key:"isBlocked",value:function(e,t){return f(this.blocked)&&this.blocked.bean===e&&this.blocked.propertyName===t}},{key:"unblock",value:function(){this.blocked=null}},{key:"notifyBeanChange",value:function(e,t,n){h("ClassRepository.notifyBeanChange(bean, propertyName, newValue)"),p(e,"bean"),p(t,"propertyName");var r=this.beanToDolphin.get(e);if(f(r)){var o=this.dolphin.findPresentationModelById(r);if(f(o)){var a=this.classes.get(o.presentationModelType)[t],i=o.findAttributeByPropertyName(t);if(f(a)&&f(i)){var l=i.getValue();return i.setValue(Rr.toDolphin(this,a,n)),Rr.fromDolphin(this,a,l)}}}}},{key:"notifyArrayChange",value:function(e,t,n,r,o){if(h("ClassRepository.notifyArrayChange(bean, propertyName, index, count, removedElements)"),p(e,"bean"),p(t,"propertyName"),p(n,"index"),p(r,"count"),p(o,"removedElements"),!this.isBlocked(e,t)){var a=this.beanToDolphin.get(e),i=e[t];if(f(a)&&f(i)){var l=Array.isArray(o)?o.length:0;this.sendListSplice(this,a,t,n,n+l,i.slice(n,n+r))}}}},{key:"onBeanAdded",value:function(e){h("ClassRepository.onBeanAdded(handler)"),p(e,"handler"),this.beanAddedHandlers.push(e)}},{key:"onBeanRemoved",value:function(e){h("ClassRepository.onBeanRemoved(handler)"),p(e,"handler"),this.beanRemovedHandlers.push(e)}},{key:"onBeanUpdate",value:function(e){h("ClassRepository.onBeanUpdate(handler)"),p(e,"handler"),this.propertyUpdateHandlers.push(e)}},{key:"onArrayUpdate",value:function(e){h("ClassRepository.onArrayUpdate(handler)"),p(e,"handler"),this.arrayUpdateHandlers.push(e)}},{key:"registerClass",value:function(e){if(h("ClassRepository.registerClass(model)"),p(e,"model"),!this.classes.has(e.id)){var t={};e.attributes.filter(function(e){return e.propertyName.search(/^@/)<0}).forEach(function(e){t[e.propertyName]=e.value}),this.classes.set(e.id,t)}}},{key:"unregisterClass",value:function(e){h("ClassRepository.unregisterClass(model)"),p(e,"model"),this.classes.delete(e.id)}},{key:"load",value:function(o){h("ClassRepository.load(model)"),p(o,"model");var a=this,i=this.classes.get(o.presentationModelType),l={};return o.attributes.filter(function(e){return e.propertyName.search(/^@/)<0}).forEach(function(r){l[r.propertyName]=null,r.onValueChange(function(e){if(e.oldValue!==e.newValue){var t=Rr.fromDolphin(a,i[r.propertyName],e.oldValue),n=Rr.fromDolphin(a,i[r.propertyName],e.newValue);a.propertyUpdateHandlers.forEach(function(e){try{e(o.presentationModelType,l,r.propertyName,n,t)}catch(e){Rr.LOGGER.error("An exception occurred while calling an onBeanUpdate-handler",e)}})}})}),this.beanFromDolphin.set(o.id,l),this.beanToDolphin.set(l,o.id),this.classInfos.set(o.id,i),this.beanAddedHandlers.forEach(function(e){try{e(o.presentationModelType,l)}catch(e){Rr.LOGGER.error("An exception occurred while calling an onBeanAdded-handler",e)}}),l}},{key:"unload",value:function(t){h("ClassRepository.unload(model)"),p(t,"model");var n=this.beanFromDolphin.get(t.id);return this.beanFromDolphin.delete(t.id),this.beanToDolphin.delete(n),this.classInfos.delete(t.id),f(n)&&this.beanRemovedHandlers.forEach(function(e){try{e(t.presentationModelType,n)}catch(e){Rr.LOGGER.error("An exception occurred while calling an onBeanRemoved-handler",e)}}),n}},{key:"spliceListEntry",value:function(e){h("ClassRepository.spliceListEntry(model)"),p(e,"model");var t=e.findAttributeByPropertyName("source"),n=e.findAttributeByPropertyName("attribute"),r=e.findAttributeByPropertyName("from"),o=e.findAttributeByPropertyName("to"),a=e.findAttributeByPropertyName("count");if(!(f(t)&&f(n)&&f(r)&&f(o)&&f(a)))throw new Error("Invalid list modification update received");var i=this.classInfos.get(t.value),l=this.beanFromDolphin.get(t.value);if(!f(l)||!f(i))throw new Error("Invalid list modification update received. Source bean unknown.");var s=e.presentationModelType;this.validateList(this,s,l,n.value);for(var u=[],c=null,d=0;d<a.value;d++){if(!f(c=e.findAttributeByPropertyName(d.toString())))throw new Error("Invalid list modification update received");u.push(Rr.fromDolphin(this,i[n.value],c.value))}try{this.block(l,n.value),this.arrayUpdateHandlers.forEach(function(e){try{e(s,l,n.value,r.value,o.value-r.value,u)}catch(e){Rr.LOGGER.error("An exception occurred while calling an onArrayUpdate-handler",e)}})}finally{this.unblock()}}},{key:"mapParamToDolphin",value:function(e){if(!f(e))return e;var t=mr(e);if("object"===t){if(e instanceof Date)return e.toISOString();var n=this.beanToDolphin.get(e);if(f(n))return n;throw new TypeError("Only managed remoting beans can be used")}if("string"===t||"number"===t||"boolean"===t)return e;throw new TypeError("Only managed remoting beans and primitive types can be used")}},{key:"mapDolphinToBean",value:function(e){return Rr.fromDolphin(this,0,e)}}],gr((Cr=Rr).prototype,br),Er&&gr(Cr,Er),Rr);function Rr(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Rr),h("ClassRepository(dolphin)"),p(e,"dolphin"),this.dolphin=e,this.classes=new Map,this.beanFromDolphin=new Map,this.beanToDolphin=new Map,this.classInfos=new Map,this.beanAddedHandlers=[],this.beanRemovedHandlers=[],this.propertyUpdateHandlers=[],this.arrayUpdateHandlers=[],this.blocked=null}wr.fixType=function(e,t){switch(e){case 1:case 2:case 3:case 4:return parseInt(t);case 5:case 6:return parseFloat(t);case 7:return"true"===String(t).toLowerCase();case 8:case 10:return String(t);default:return t}},wr.fromDolphin=function(e,t,n){if(!f(n))return null;switch(t){case 0:return e.beanFromDolphin.get(String(n));case 9:case 11:case 55:case 52:case 54:return new Date(String(n));default:return wr.fixType(t,n)}},wr.toDolphin=function(e,t,n){if(!f(n))return null;switch(t){case 0:return e.beanToDolphin.get(n);case 9:case 11:case 55:case 52:case 54:return n instanceof Date?n.toISOString():n;default:return wr.fixType(t,n)}},wr.LOGGER=T.getLogger("ClassRepository");var Tr=wr;function kr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ar,Pr,Or,Mr=(Pr=[{key:"getModel",value:function(){return this.model}},{key:"getId",value:function(){return this.controllerId}},{key:"invoke",value:function(e,t){if(h("ControllerProxy.invoke(name, params)"),p(e,"name"),this.destroyed)throw new Error("The controller was already destroyed");return this.manager.invokeAction(this.controllerId,e,t)}},{key:"createController",value:function(e){return this.manager._createController(e,this.getId())}},{key:"destroy",value:function(){var t=this;if(this.destroyed)throw new Error("The controller was already destroyed");return this.destroyed=!0,this.onDestroyedHandlers.forEach(function(e){try{e(t)}catch(e){_r.LOGGER.error("An exception occurred while calling an onDestroyed-handler",e)}},this),this.manager.destroyController(this)}},{key:"onDestroyed",value:function(e){h("ControllerProxy.onDestroyed(handler)"),p(e,"handler");var t=this;return this.onDestroyedHandlers.add(e),{unsubscribe:function(){t.onDestroyedHandlers.delete(e)}}}}],kr((Ar=_r).prototype,Pr),Or&&kr(Ar,Or),_r);function _r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_r),h("ControllerProxy(controllerId, model, manager)"),p(e,"controllerId"),p(t,"model"),p(n,"manager"),this.controllerId=e,this.model=t,this.manager=n,this.destroyed=!1,this.onDestroyedHandlers=new Set}function Ir(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Mr.LOGGER=T.getLogger("ControllerProxy");var Sr,Nr,Lr="controllerId",Dr="errorCode",Hr=(Ir((Sr=Br).prototype,[{key:"createController",value:function(e){return this._createController(e,null)}},{key:"_createController",value:function(e,n){h("ControllerManager.createController(name)"),p(e,"name");var i=this;return new Promise(function(o,a){i.connector.getHighlanderPM().then(function(t){var r="Error creating controller: ";i.connector.invoke(Bn.createCreateControllerCommand(e,n)).then(function(){var n;i.getValueWithRetry(function(){return t.findAttributeByPropertyName(Lr).getValue()},"Could not get an controllerID from highlanderPM.").then(function(e){return n=e,i.getValueWithRetry(function(){return t.findAttributeByPropertyName("model").getValue()},"Could not get an modelID from highlanderPM.")}).then(function(e){return i.getValueWithRetry(function(){return i.classRepository.mapDolphinToBean(e)},"Could not get an model from classRepository for ID: "+e)}).then(function(e){try{var t=new Mr(n,e,i);i.controllers.add(t),o(t)}catch(e){a(r+e)}}).catch(function(e){a(r+e)})}).catch(function(e){a(r+e)})})})}},{key:"getValueWithRetry",value:function(a,i){return new Promise(function(t,n){var r=0,o=setInterval(function(){var e=a();null==e?1e3<=++r&&(clearInterval(o),n(i+" after "+r+" retries.")):(clearInterval(o),t(e))},5)})}},{key:"invokeAction",value:function(l,s,u){h("ControllerManager.invokeAction(controllerId, actionName, params)"),p(l,"controllerId"),p(s,"actionName");var c=this;return new Promise(function(e,t){var n=[c.dolphin.attribute(sr,null,"client"),c.dolphin.attribute(Dr)],r=c.dolphin.presentationModel.apply(c.dolphin,[null,lr].concat(n)),o=[];if(f(u))for(var a in u)if(u.hasOwnProperty(a)){var i=c.classRepository.mapParamToDolphin(u[a]);o.push({name:a,value:i})}c.connector.invoke(Bn.createCallActionCommand(l,s,o)).then(function(){r.findAttributeByPropertyName(Dr).getValue()?t(new Error("Server side ControllerAction "+s+" caused an error. Please see server log for details.")):e(),c.dolphin.deletePresentationModel(r)}).catch(t)})}},{key:"destroyController",value:function(r){h("ControllerManager.destroyController(controller)"),p(r,"controller");var o=this;return new Promise(function(t,n){o.connector.getHighlanderPM().then(function(e){o.controllers.delete(r),e.findAttributeByPropertyName(Lr).setValue(r.controllerId),o.connector.invoke(Bn.createDestroyControllerCommand(r.getId())).then(t).catch(n)})})}},{key:"destroy",value:function(){var e=this.controllers,t=[];return this.controllers=new Set,e.forEach(function(e){try{t.push(e.destroy())}catch(e){}}),Promise.all(t)}}]),Nr&&Ir(Sr,Nr),Br);function Br(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Br),h("ControllerManager(dolphin, classRepository, connector)"),p(e,"dolphin"),p(t,"classRepository"),p(n,"connector"),this.dolphin=e,this.classRepository=t,this.connector=n,this.controllers=new Set}var Gr=n(0),Ur=n.n(Gr);function xr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var jr,Vr,qr=(xr((jr=Fr).prototype,[{key:"connect",value:function(){var n=this;return this.connectionPromise=new Promise(function(e,t){n._connector.connect(),n._connector.invoke(Bn.createCreateContextCommand()).then(function(){n.isConnected=!0,e()}).catch(t)}),this.connectionPromise}},{key:"onConnect",value:function(){return f(this.connectionPromise)?this.isConnected?new Promise(function(e){e()}):this.connectionPromise:this.connect()}},{key:"createController",value:function(e){return h("ClientContext.createController(name)"),p(e,"name"),this._controllerManager.createController(e)}},{key:"disconnect",value:function(){var t=this;return this.dolphin.stopPushListening(),new Promise(function(e){t._controllerManager.destroy().then(function(){t._connector.invoke(Bn.createDestroyContextCommand()),t.dolphin=null,t.beanManager=null,t._controllerManager=null,t._connector=null,e()})})}}]),Vr&&xr(jr,Vr),Fr);function Fr(e,t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Fr),h("ClientContext(dolphin, beanManager, controllerManager, connector)"),p(e,"dolphin"),p(t,"beanManager"),p(n,"controllerManager"),p(r,"connector"),this.dolphin=e,this.beanManager=t,this._controllerManager=n,this._connector=r,this.connectionPromise=null,this.isConnected=!1}function Qr(e){return(Qr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Xr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Yr(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Jr(e,t)}function Wr(a){return function(){var e,t,n,r=$r(a);if(Zr()){var o=$r(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return t=this,!(n=e)||"object"!==Qr(n)&&"function"!=typeof n?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(t):n}}function Kr(e){var r="function"==typeof Map?new Map:void 0;return(Kr=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return zr(e,arguments,$r(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Jr(n,e)})(e)}function zr(e,t,n){return(zr=Zr()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&Jr(o,n.prototype),o}).apply(null,arguments)}function Zr(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}function Jr(e,t){return(Jr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function $r(e){return($r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Ur()(qr.prototype);var eo=function(){Yr(o,Kr(Error));var r=Wr(o);function o(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Remoting Error",n=1<arguments.length?arguments[1]:void 0;return Xr(this,o),(e=r.call(this,t)).detail=n||void 0,e}return o}(),to=function(){Yr(n,Kr(Error));var t=Wr(n);function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Session Error";return Xr(this,n),t.call(this,e)}return n}();(function(){Yr(n,Kr(Error));var t=Wr(n);function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Http Response Error";return Xr(this,n),t.call(this,e)}})(),function(){Yr(n,Kr(Error));var t=Wr(n);function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Http Network Error";return Xr(this,n),t.call(this,e)}}();function no(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ro,oo,ao,io=(oo=[{key:"onError",value:function(e){lo.LOGGER.error(e)}}],no((ro=lo).prototype,oo),ao&&no(ro,ao),lo);function lo(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,lo)}function so(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}io.LOGGER=T.getLogger("RemotingErrorHandler");var uo,co,fo,ho=(co=[{key:"_connectionConfig",value:function(){return f(this.config)?this.config.connection:null}},{key:"_handleError",value:function(e,t){var n=this._connectionConfig();(f(n)&&f(n.errorHandlers)?n.errorHandlers:[new io]).forEach(function(e){e.onError(t)}),e(t)}},{key:"_send",value:function(l){var s=this,u=this;return new Promise(function(t,n){if(s.client){var e=en.encode(l);if(po.LOGGER.isLogLevelUseable(c.DEBUG)&&!po.LOGGER.isLogLevelUseable(c.TRACE))for(var r=0;r<l.length;r++){var o=l[r];o.id===Be&&po.LOGGER.debug("send",o,e)}var a=1===l.length&&l[0].id===He,i=s.client.getService("HttpClient");i&&u.failed_attempt<=u.maxRetry?i.post(u.url).withHeadersInfo(s.headersInfo).withContent(e).readString().execute(a).then(function(e){t(e.content)}).catch(function(e){var t=e.getStatus();u.failed_attempt+=1,408===t?u._handleError(n,new to("PlatformHttpTransmitter: Session Timeout")):u._handleError(n,e)}):po.LOGGER.error("Cannot reach the sever")}else po.LOGGER.error("No Rico client found!")})}},{key:"transmit",value:function(e,o,a){var i=this;this._send(e).then(function(t){if(0<t.trim().length)try{var e=en.decode(t);o(e)}catch(e){var n="PlatformHttpTransmitter: Parse error: (Incorrect response = "+t+")";i.emit("error",new eo(n)),a(n)}else{var r="PlatformHttpTransmitter: Empty response";i.emit("error",new eo(r)),a(r)}}).catch(function(e){i.emit("error",e),a(e)})}},{key:"signal",value:function(e){var t=this;this._send([e]).catch(function(e){return t.emit("error",e)})}}],so((uo=po).prototype,co),fo&&so(uo,fo),po);function po(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,po),this.url=e,this.config=t,this.client=n,this.headersInfo=f(t)?t.headersInfo:null,this.failed_attempt=0;var r=this._connectionConfig();this.maxRetry=f(r)&&f(r.maxRetry)?r.maxRetry:3,this.timeout=f(r)&&f(r.timeout)?r.timeout:5e3}function vo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}ho.LOGGER=T.getLogger("PlatformHttpTransmitter"),Ur()(ho.prototype);var yo,mo,go,Co=(mo=[{key:"create",value:function(e,t){h("connect(url, config)"),p(e,"url"),bo.LOGGER.debug("Creating client context",e,t);var n=new ho(e,t,this.client);n.on("error",function(e){s.emit("error",e)});var r=nr.withTransmitter(n).withSlackMS(4).withMaxBatchSize(Number.MAX_SAFE_INTEGER).build(),o=new Tr(r),a=new vr(o),i=new ur(e,r,o,t),l=new Hr(r,o,i),s=new qr(r,a,l,i);return bo.LOGGER.debug("clientContext created with",s),s}}],vo((yo=bo).prototype,mo),go&&vo(yo,go),bo);function bo(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,bo),!(this.client=e)&&bo.legecyClientSupport&&(bo.LOGGER.warn("Legecy support used."),this.client=bo.legecyClientSupport)}Co.LOGGER=T.getLogger("ClientContextFactory"),Co.legecyClientSupport=!1;function Eo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var wo,Ro,To=(Eo((wo=ko).prototype,[{key:"createDirectConnection",value:function(e,t){h("createDirectConnection"),p(e,"authEndpoint"),p(t,"realmName");var n=new XMLHttpRequest;return n.open(D.METHOD.POST,e+"/auth/realms/"+t+"/protocol/openid-connect/token",!0),n.setRequestHeader(D.HEADER_NAME.CONTENT_TYPE,D.CONTENT_TYPE.APPLICATION_X_WWW_FORM_URLENCODED),n.responseType=L,n}},{key:"createServerProxyConnection",value:function(e,t){h("createServerProxyConnection"),p(e,"authEndpoint");var n=new XMLHttpRequest;return n.open(D.METHOD.POST,e,!0),n.setRequestHeader(D.HEADER_NAME.CONTENT_TYPE,D.CONTENT_TYPE.TEXT_PLAIN),f(t)&&n.setRequestHeader(D.HEADER_NAME.X_PLATFORM_SECURITY_REALM,t),n.responseType=L,n}}]),Ro&&Eo(wo,Ro),ko);function ko(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,ko)}function Ao(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Po,Oo,Mo,_o=(Oo=[{key:"createLoginConnection",value:function(e,t,n,r,o,a){var i,l,s=encodeURIComponent(o),u=encodeURIComponent(a),c=encodeURIComponent(r);if(e){if(!f(r))throw Error("No app name set!");i=this.connection.createDirectConnection(t,n),l="client_id="+c+"&username="+s+"&password="+u+"&grant_type=password"}else i=this.connection.createServerProxyConnection(t,n),l="username="+s+"&password="+u+"&grant_type=password";return{connection:i,content:l}}},{key:"createRefreshConnection",value:function(e,t,n,r,o){var a,i,l=encodeURIComponent(r);if(e){if(!f(r))throw Error("No app name set!");a=this.connection.createDirectConnection(t,n),i="grant_type=refresh_token&refresh_token="+o+"&client_id="+l}else a=this.connection.createServerProxyConnection(t,n),i="grant_type=refresh_token&refresh_token="+o;return{connection:a,content:i}}},{key:"receiveToken",value:function(n,r){return new Promise(function(e,t){n.ontimeout=function(e){t(e)},n.onerror=function(e){t(e)},n.onreadystatechange=function(){this.readyState===D.XMLHTTPREQUEST_READYSTATE.DONE&&this.status===D.STATUS.OK?e(this.response):this.readyState===D.XMLHTTPREQUEST_READYSTATE.DONE&&this.status!==D.STATUS.OK&&t(this.status)},Io.LOGGER.trace("Receiving token"),n.send(r)})}},{key:"refreshToken",value:function(e,t,n,r,o){var a=this.createRefreshConnection(e,t,n,r,o),i=a.connection,l=a.content;return this.receiveToken(i,l)}}],Ao((Po=Io).prototype,Oo),Mo&&Ao(Po,Mo),Io);function Io(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Io),this.connection=new To}function So(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}_o.LOGGER=T.getLogger("KeycloakFunctions");var No,Lo,Do,Ho=(Lo=[{key:"setToken",value:function(e){this.token=e}},{key:"setAppName",value:function(e){this.appName=e}},{key:"setRealm",value:function(e){this.realm=e}},{key:"handleRequest",value:function(e){h("handleRequest"),p(e,"httpRequest"),f(this.token)&&(Bo.LOGGER.trace("Using token",this.token),e.setRequestHeader(D.HEADER_NAME.AUTHORIZATION,"Bearer "+this.token)),f(this.appName)&&(Bo.LOGGER.trace("Using appName",this.appName),e.setRequestHeader(D.HEADER_NAME.X_PLATFORM_SECURITY_APPLICATION,this.appName)),f(this.realm)&&(Bo.LOGGER.trace("Using realm",this.realm),e.setRequestHeader(D.HEADER_NAME.X_PLATFORM_SECURITY_REALM,this.realm)),e.setRequestHeader(D.HEADER_NAME.X_PLATFORM_SECURITY_BEARER_ONLY,"true")}}],So((No=Bo).prototype,Lo),Do&&So(No,Do),Bo);function Bo(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Bo),this.token=null,this.appName=null,this.realm=null}function Go(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Ho.LOGGER=T.getLogger("SecurityHttpClientInterceptor");var Uo,xo,jo,Vo=(xo=[{key:"login",value:function(e,t,n){var a=this;if(this.isAuthorized())throw new Error("Already logged in!");n&&(this.configuration.directConnection=n.directConnection||this.configuration.directConnection,this.configuration.authEndpoint=n.authEndpoint||this.configuration.authEndpoint,this.configuration.appName=n.appName||this.configuration.appName,this.configuration.realmName=n.realmName||this.configuration.realmName);var r=this.configuration,i=r.directConnection,l=r.authEndpoint,s=r.appName,u=r.realmName,o=this.functions.createLoginConnection(i,l,u,s,e,t),c=o.connection,d=o.content,f=this;return new Promise(function(r,o){qo.LOGGER.debug("Receiving access token"),a.functions.receiveToken(c,d).then(function(e){if(e&&e.access_token){f.token=e,a.interceptor.setToken(e.access_token),a.interceptor.setRealm(u),a.interceptor.setAppName(s);var t=e.expires_in||qo.MIN_TOKEN_EXPIRES_RUN,n=Math.max(qo.MIN_TOKEN_EXPIRES_RUN,t-qo.TOKEN_EXPIRES_DELTA);f.intervall=setInterval(function(){qo.LOGGER.debug("Refreshing access token"),f.functions.refreshToken(i,l,u,s,e.refresh_token).then(function(e){f.token=e,f.interceptor.setToken(e.access_token)})},n),r(e.access_token)}else o("No access token found")}).catch(function(e){return o(e)})})}},{key:"logout",value:function(){var t=this,n=this;return qo.LOGGER.debug("Logout"),new Promise(function(e){delete n.token,n.interceptor.setToken(null),f(t.intervall)&&(clearInterval(t.intervall),t.intervall=null),e()})}},{key:"isAuthorized",value:function(){return f(this.token)}},{key:"initServiceProvider",value:function(e){h("initServiceProvider"),p(e,"client"),e.getService("HttpClientInterceptor").addRequestInterceptor(this.interceptor)}}],Go((Uo=qo).prototype,xo),jo&&Go(Uo,jo),qo);function qo(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,qo),this.functions=new _o,this.interceptor=new Ho,this.intervall=null,this.configuration={directConnection:!1,authEndpoint:H,appName:null,realmName:null}}function Fo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Vo.TOKEN_EXPIRES_DELTA=1e4,Vo.MIN_TOKEN_EXPIRES_RUN=3e4,Vo.LOGGER=T.getLogger("KeycloakSecurity"),function(e){if(f(e)){var t=new _(fe,"HttpClient",e),n=new _(me,"HttpClientInterceptor",e);e.registerServiceProvider(t),e.registerServiceProvider(n)}}(A),function(e){if(f(e)){var t=new _(Re,"ClientScope");e.registerServiceProvider(t)}}(A),function(e){if(f(e)){var t=new _(Co,"ClientContextFactory",e);e.registerServiceProvider(t)}}(A),function(e){if(f(e)){var t=new _(Vo,"Security",e);e.registerServiceProvider(t)}}(A),A.init();var Qo,Xo,Yo=A.getService,Wo=A.hasService,Ko=A.registerServiceProvider;if(A.LOGGER.info("Rico Version:","1.0.1"),window.Worker&&window.Blob&&window.URL&&URL.createObjectURL){A.LOGGER.debug("Creating Worker");var zo=(Fo((Qo=Jo).prototype,[{key:"createWorker",value:function(){return new Worker(URL.createObjectURL(this.blob))}}]),Xo&&Fo(Qo,Xo),Jo),Zo=new _(zo,"HttpWorker");A.registerServiceProvider(Zo)}function Jo(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,Jo),this.blob=new Blob(["self.handleTimeout = function() {    const message = this.statusText || 'Timeout occurred';    const workerMessage = {error: true, message, status: this.status, timedout: true};    self.postMessage(workerMessage);};self.handleError = function () {    let message = this.statusText || 'Unspecified error occured';    const workerMessage = {error: true, message, status: this.status, timedout: false};    self.postMessage(workerMessage);};self.handleStateChange = function () {    if (this.readyState === 4 && this.status >= 200 && this.status < 300) {        const workerMessage = {error: false, response: this.response, status: this.status, url: this.url, responseHeaders: this.getAllResponseHeaders()};        self.postMessage(workerMessage);    } else if (this.readyState === 4 && this.status >= 300) {        const workerMessage = {error: true, message: this.statusText, status: this.status, timedout: false};        self.postMessage(workerMessage);    }};self.addEventListener('message', function(event) {    const timeout = event.data.timeout || 0;    const configuration = event.data.conf || {};    const requestHeaders = event.data.requestHeaders || [];        const httpRequest = new XMLHttpRequest();    const async = true;        httpRequest.open(configuration.method, configuration.url, async);    httpRequest.url = configuration.url;    httpRequest.method = configuration.method;    httpRequest.withCredentials = true;    for (let i = 0; i < requestHeaders.length; i++) {        const header = requestHeaders[i];        httpRequest.setRequestHeader(header.name, header.value);    }    if (configuration.headers && configuration.headers.length > 0) {        for (let i = 0; i < configuration.headers.length; i++) {            const header = configuration.headers[i];            httpRequest.setRequestHeader(header.name, header.value);        }    }    httpRequest.timeout = timeout;    if (configuration.responseType) {        httpRequest.responseType = configuration.responseType;    }    httpRequest.ontimeout = self.handleTimeout.bind(httpRequest);    httpRequest.onerror = self.handleError.bind(httpRequest);    httpRequest.onreadystatechange = self.handleStateChange.bind(httpRequest);    httpRequest.send(configuration.requestBody);});"],{type:"application/javascript"})}var $o=T.getLogger("Deprecated:"),ea=!0;function ta(){ea&&($o.warn('Please do not use "dolphin" anymore, it may be removed in the next version! Use the new API instead!'),ea=!1)}window&&(window.dolphin={get ClientContextFactory(){return ta(),Co.legecyClientSupport=A,Co},get createClientContext(){return ta(),new Co(A).create},get LoggerFactory(){return ta(),T},get LogLevel(){return ta(),c}})}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=1);function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var n,r});
//# sourceMappingURL=rico.min.js.map